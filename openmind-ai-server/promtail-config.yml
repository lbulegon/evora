# Configuração Promtail para OpenMind AI Server
# Este arquivo deve ser colocado em /etc/promtail/promtail-config.yml (ou onde o Promtail está configurado)
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push  # URL do Loki

scrape_configs:
  # Logs gerais da aplicação
  - job_name: openmind-ai-app
    static_configs:
      - targets:
          - localhost
        labels:
          job: openmind-ai
          log_type: app
          service: openmind-ai-server
          __path__: /var/log/openmind-ai/app.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            file: file
            line: line
            request_id: request_id
            endpoint: endpoint
            method: method
            status_code: status_code
            processing_time_ms: processing_time_ms
      
      - labels:
          level:
          logger:
          module:
          request_id:
          endpoint:
          method:
          status_code:
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Logs de erros
  - job_name: openmind-ai-errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: openmind-ai
          log_type: error
          service: openmind-ai-server
          __path__: /var/log/openmind-ai/errors.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            exception: exception
            exception_type: exception_type
            request_id: request_id
      
      - labels:
          level:
          logger:
          exception_type:
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Logs de acesso (HTTP requests)
  - job_name: openmind-ai-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: openmind-ai
          log_type: access
          service: openmind-ai-server
          __path__: /var/log/openmind-ai/access.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            request_id: request_id
            method: method
            endpoint: endpoint
            status_code: status_code
            processing_time_ms: processing_time_ms
            ip_address: ip_address
            user_agent: user_agent
      
      - labels:
          method:
          endpoint:
          status_code:
          request_id:
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Logs de análise de imagens
  - job_name: openmind-ai-analysis
    static_configs:
      - targets:
          - localhost
        labels:
          job: openmind-ai
          log_type: analysis
          service: openmind-ai-server
          __path__: /var/log/openmind-ai/analysis.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            request_id: request_id
            image_filename: image_filename
            image_size_bytes: image_size_bytes
            processing_time_ms: processing_time_ms
            api_provider: api_provider
            success: success
            product_name: product_name
            category: category
      
      - labels:
          api_provider:
          success:
          category:
          request_id:
      
      - timestamp:
          source: timestamp
          format: RFC3339

  # Logs de métricas
  - job_name: openmind-ai-metrics
    static_configs:
      - targets:
          - localhost
        labels:
          job: openmind-ai
          log_type: metrics
          service: openmind-ai-server
          __path__: /var/log/openmind-ai/metrics.log
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
      
      - timestamp:
          source: timestamp
          format: RFC3339



