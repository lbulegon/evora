{% extends 'app_marketplace/base.html' %}
{% load static %}

{% block title %}Conversa: {{ conversation.participant.name|default:conversation.participant.phone }} - √âVORA Connect{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }
    
    .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .chat-header-info {
        flex: 1;
    }
    
    .chat-header-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #ece5dd;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='%23e0e0e0'/%3E%3Cpath d='M0 0h50v50H0z' fill='%23f5f5f5'/%3E%3C/svg%3E");
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }
    
    .message.from-customer {
        align-items: flex-start;
    }
    
    .message.from-agent {
        align-items: flex-end;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.from-customer .message-bubble {
        background: white;
        border-top-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .message.from-agent .message-bubble {
        background: #dcf8c6;
        border-top-right-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .message-time {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 0.25rem;
        padding: 0 0.5rem;
    }
    
    .message-status {
        font-size: 0.7rem;
        margin-left: 0.5rem;
    }
    
    .message-status.read {
        color: #4fc3f7;
    }
    
    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background: white;
    }
    
    .chat-sidebar {
        width: 300px;
        border-left: 1px solid #dee2e6;
        background: #f8f9fa;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .conversation-detail-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .conversation-detail-card h6 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 500;
        color: #495057;
    }
    
    .detail-value {
        color: #6c757d;
    }
    
    .tag-item {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.25rem 0.25rem 0;
        background: #e9ecef;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .note-item {
        background: #fff3cd;
        border-left: 3px solid #ffc107;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .note-author {
        font-weight: 600;
        font-size: 0.75rem;
        color: #856404;
        margin-bottom: 0.25rem;
    }
    
    .note-content {
        color: #856404;
    }
    
    .note-time {
        font-size: 0.7rem;
        color: #856404;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .order-link {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #0d6efd;
        color: white;
        border-radius: 4px;
        text-decoration: none;
        margin: 0.25rem 0.25rem 0.25rem 0;
        font-size: 0.875rem;
        transition: background 0.2s;
    }
    
    .order-link:hover {
        background: #0b5ed7;
        color: white;
    }
    
    .empty-chat {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
        text-align: center;
        padding: 2rem;
    }
    
    .empty-chat i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .priority-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'conversations_inbox' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
        <h1 class="h3 mb-0">
            <i class="fab fa-whatsapp text-success"></i> Conversa Individual
        </h1>
        <div></div>
    </div>

    <div class="row">
        <!-- Chat Principal -->
        <div class="col-md-9">
            <div class="chat-container">
                <!-- Header do Chat -->
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="d-flex align-items-center gap-2">
                            <h5 class="mb-0">{{ conversation.participant.name|default:conversation.participant.phone }}</h5>
                            {% if conversation.cliente %}
                            <span class="badge bg-info">Cliente Cadastrado</span>
                            {% endif %}
                            <span class="status-badge bg-{% if conversation.status == 'new' %}danger{% elif conversation.status == 'open' %}primary{% elif conversation.status == 'waiting' %}warning{% elif conversation.status == 'resolved' %}success{% else %}secondary{% endif %}">
                                {{ conversation.get_status_display }}
                            </span>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-phone"></i> {{ conversation.participant.phone }}
                            {% if conversation.group %}
                            | Grupo: {{ conversation.group.name }}
                            {% endif %}
                        </small>
                    </div>
                    <div class="chat-header-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('conversationDetails').classList.toggle('d-none')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mensagens -->
                <div class="chat-messages" id="chatMessages">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message {% if message.is_from_customer %}from-customer{% else %}from-agent{% endif %}">
                            <div class="message-bubble">
                                <div>{{ message.content|linebreaks }}</div>
                                {% if message.media_url %}
                                <div class="mt-2">
                                    <a href="{{ message.media_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file"></i> Ver anexo
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            <div class="message-time">
                                {{ message.timestamp|date:"d/m/Y H:i" }}
                                {% if not message.is_from_customer and message.read %}
                                <span class="message-status read">
                                    <i class="fas fa-check-double"></i> Lida
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-chat">
                            <i class="fab fa-whatsapp"></i>
                            <h5>Nenhuma mensagem ainda</h5>
                            <p class="text-muted">Esta conversa ainda n√£o possui mensagens.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Input de Mensagem -->
                <div class="chat-input-container">
                    <form id="messageForm" method="post" action="{% url 'api_send_conversation_message' conversation.conversation_id %}">
                        {% csrf_token %}
                        <div class="input-group">
                            <textarea name="message" class="form-control" rows="2" 
                                      placeholder="Digite sua mensagem..." 
                                      id="messageInput" 
                                      required></textarea>
                            <button type="submit" class="btn btn-success">
                                <i class="fab fa-whatsapp"></i> Enviar
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle"></i> Mensagens enviadas ser√£o processadas e encaminhadas via WhatsApp
                        </small>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar de Detalhes -->
        <div class="col-md-3">
            <div class="chat-sidebar" id="conversationDetails">
                <!-- Informa√ß√µes da Conversa -->
                <div class="conversation-detail-card">
                    <h6>üìã Informa√ß√µes</h6>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <select id="statusSelect" class="form-select form-select-sm" onchange="updateStatus(this.value)">
                                {% for value, label in conversation.STATUS_CHOICES %}
                                <option value="{{ value }}" {% if conversation.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Prioridade:</span>
                        <span class="detail-value">
                            <span class="priority-indicator 
                                {% if conversation.priority >= 9 %}bg-danger
                                {% elif conversation.priority >= 7 %}bg-warning
                                {% elif conversation.priority >= 5 %}bg-info
                                {% elif conversation.priority >= 3 %}bg-success
                                {% else %}bg-secondary{% endif %}"></span>
                            {{ conversation.get_priority_display }}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Atribu√≠da a:</span>
                        <span class="detail-value">
                            {% if conversation.assigned_to %}
                            {{ conversation.assigned_to.get_full_name|default:conversation.assigned_to.username }}
                            {% else %}
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="assignToMe()">Atribuir a mim</button>
                            {% endif %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Iniciada:</span>
                        <span class="detail-value">{{ conversation.first_message_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">√öltima mensagem:</span>
                        <span class="detail-value">{{ conversation.last_message_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total mensagens:</span>
                        <span class="detail-value">{{ conversation.message_count }}</span>
                    </div>
                    {% if conversation.unread_count > 0 %}
                    <div class="detail-item">
                        <span class="detail-label">N√£o lidas:</span>
                        <span class="detail-value">
                            <span class="badge bg-danger">{{ conversation.unread_count }}</span>
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Tags -->
                {% if conversation.tags or True %}
                <div class="conversation-detail-card">
                    <h6>üè∑Ô∏è Tags</h6>
                    <div>
                        {% if conversation.tags %}
                            {% for tag in conversation.tags %}
                            <span class="tag-item">#{{ tag }}</span>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">Nenhuma tag</small>
                        {% endif %}
                    </div>
                    <form id="tagForm" method="post" class="mt-2" onsubmit="addTag(event)">
                        {% csrf_token %}
                        <div class="input-group input-group-sm">
                            <input type="text" id="tagInput" class="form-control" placeholder="Adicionar tag">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
                
                <!-- Pedidos Relacionados -->
                {% if conversation.related_orders.exists %}
                <div class="conversation-detail-card">
                    <h6>üõí Pedidos Relacionados</h6>
                    {% for order in conversation.related_orders.all %}
                    <a href="{% url 'shopper_order_detail' order.id %}" class="order-link">
                        <i class="fas fa-shopping-cart"></i> Pedido #{{ order.id }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Notas Internas -->
                <div class="conversation-detail-card">
                    <h6>üìù Notas Internas</h6>
                    {% if conversation.internal_notes.exists %}
                        {% for note in conversation.internal_notes.all %}
                        <div class="note-item">
                            <div class="note-author">
                                {{ note.author.get_full_name|default:note.author.username }}
                            </div>
                            <div class="note-content">{{ note.content }}</div>
                            <div class="note-time">{{ note.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">Nenhuma nota</small>
                    {% endif %}
                    <form id="noteForm" method="post" class="mt-2" onsubmit="addNote(event)">
                        {% csrf_token %}
                        <div class="mb-2">
                            <textarea id="noteContent" class="form-control form-control-sm" rows="3" 
                                      placeholder="Adicionar nota interna..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-outline-warning w-100">
                            <i class="fas fa-plus"></i> Adicionar Nota
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const conversationId = '{{ conversation.conversation_id }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Auto-scroll para a √∫ltima mensagem
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Auto-refresh a cada 15 segundos
    setTimeout(function() {
        location.reload();
    }, 15000);
    
    // Envio de mensagem via AJAX
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                return false;
            }
            
            try {
                const response = await fetch(`/api/conversations/${conversationId}/send-message/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ message: messageText })
                });
                
                const data = await response.json();
                if (data.success || response.ok) {
                    messageInput.value = '';
                    location.reload(); // Recarregar para mostrar a nova mensagem
                } else {
                    alert('Erro ao enviar mensagem: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            }
        });
    }
    
    // Atualizar status
    async function updateStatus(newStatus) {
        try {
            const response = await fetch(`/api/conversations/${conversationId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            const data = await response.json();
            if (data.success || response.ok) {
                location.reload();
            } else {
                alert('Erro ao atualizar status: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao atualizar status. Tente novamente.');
        }
    }
    
    // Atribuir a mim
    async function assignToMe() {
        try {
            const response = await fetch(`/api/conversations/${conversationId}/assign/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            if (data.success || response.ok) {
                location.reload();
            } else {
                alert('Erro ao atribuir conversa: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao atribuir conversa. Tente novamente.');
        }
    }
    
    // Adicionar tag
    async function addTag(e) {
        e.preventDefault();
        const tagInput = document.getElementById('tagInput');
        const tag = tagInput.value.trim();
        
        if (!tag) {
            return false;
        }
        
        try {
            const response = await fetch(`/api/conversations/${conversationId}/tags/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ tag: tag })
            });
            
            const data = await response.json();
            if (data.success || response.ok) {
                tagInput.value = '';
                location.reload();
            } else {
                alert('Erro ao adicionar tag: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao adicionar tag. Tente novamente.');
        }
    }
    
    // Adicionar nota
    async function addNote(e) {
        e.preventDefault();
        const noteContent = document.getElementById('noteContent');
        const content = noteContent.value.trim();
        
        if (!content) {
            return false;
        }
        
        try {
            const response = await fetch(`/api/conversations/${conversationId}/notes/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ content: content })
            });
            
            const data = await response.json();
            if (data.success || response.ok) {
                noteContent.value = '';
                location.reload();
            } else {
                alert('Erro ao adicionar nota: ' + (data.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao adicionar nota. Tente novamente.');
        }
    }
</script>
{% endblock %}

