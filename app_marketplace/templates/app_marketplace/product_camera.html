{% extends 'app_marketplace/base.html' %}
{% load static %}

{% block title %}Fotografar Produto - 칄VORA Connect{% endblock %}

{% block extra_css %}
<style>
    .camera-container {
        max-width: 800px;
        margin: 2rem auto;
    }
    
    .camera-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .camera-preview {
        width: 100%;
        max-width: 100%;
        border-radius: 10px;
        background: #000;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .camera-preview video,
    .camera-preview canvas,
    .camera-preview img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
    }
    
    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-camera {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 4px solid white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    
    .btn-camera:active {
        transform: scale(0.95);
    }
    
    .btn-capture {
        background: #28a745;
        color: white;
    }
    
    .btn-capture:hover {
        background: #218838;
    }
    
    .btn-retake {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-retake:hover {
        background: #e0a800;
    }
    
    .btn-close-camera {
        background: #dc3545;
        color: white;
    }
    
    .btn-close-camera:hover {
        background: #c82333;
    }
    
    .form-section {
        display: none; /* Mostrar apenas ap칩s foto capturada */
    }
    
    .form-section.active {
        display: block;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .error-message.show {
        display: block;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .success-message.show {
        display: block;
    }
    
    .camera-status {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .permission-prompt {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        border-radius: 10px;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="camera-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Fotografar Produto
            </h1>
            <a href="{% url 'shopper_products' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
        
        <!-- Mensagens -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- Se칞칚o da C칙mera -->
        <div class="camera-section" id="cameraSection">
            <h5 class="mb-3">游닝 Capturar Foto</h5>
            
            <div class="camera-status" id="cameraStatus">
                <i class="fas fa-circle-notch fa-spin"></i> Preparando c칙mera...
            </div>
            
            <div class="permission-prompt" id="permissionPrompt" style="display: none;">
                <i class="fas fa-camera" style="font-size: 3rem; color: #ffc107;"></i>
                <h5>Permiss칚o de C칙mera Necess치ria</h5>
                <p>Clique em "Iniciar C칙mera" para permitir o acesso  c칙mera do seu dispositivo.</p>
                <button class="btn btn-primary" onclick="startCamera()">
                    <i class="fas fa-video"></i> Iniciar C칙mera
                </button>
            </div>
            
            <div class="camera-preview" id="cameraPreview">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 4rem;"></i>
                    <p>Inicie a c칙mera para come칞ar</p>
                </div>
            </div>
            
            <div class="camera-controls" id="cameraControls" style="display: none;">
                <button class="btn btn-close-camera btn-camera" onclick="stopCamera()" title="Fechar c칙mera">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-capture btn-camera" onclick="capturePhoto()" title="Capturar foto">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            
            <!-- Canvas oculto para processar imagem -->
            <canvas id="captureCanvas" style="display: none;"></canvas>
        </div>
        
        <!-- Se칞칚o do Formul치rio -->
        <div class="camera-section form-section" id="formSection">
            <h5 class="mb-3">游닇 Dados do Produto</h5>
            
            <form id="productForm" onsubmit="submitProduct(event)">
                {% csrf_token %}
                
                <!-- Preview da Imagem -->
                <div class="text-center mb-3">
                    <img id="imagePreview" src="" alt="Preview" class="image-preview" style="display: none;">
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nome do Produto *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Pre칞o</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" name="price" class="form-control" step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Descri칞칚o</label>
                    <textarea name="description" class="form-control" rows="3" placeholder="Descri칞칚o do produto..."></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" name="brand" class="form-control" placeholder="Ex: Nike, Apple, etc.">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select name="category" class="form-select">
                                <option value="">Selecione...</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Grupo WhatsApp *</label>
                    <select name="group_id" class="form-select" required>
                        <option value="">Selecione um grupo...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Produto ser치 adicionado ao grupo selecionado</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Empresa/Estabelecimento (Opcional)</label>
                    <select name="empresa_id" class="form-select">
                        <option value="">Nenhuma</option>
                        {% for empresa in empresas %}
                        <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <input type="hidden" name="currency" value="BRL">
                <input type="hidden" name="image_blob" id="imageBlob">
                
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-secondary" onclick="retakePhoto()">
                        <i class="fas fa-redo"></i> Refazer Foto
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Produto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div>
        <div class="loading-spinner"></div>
        <p class="text-white mt-3">Processando...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;
let capturedBlob = null;
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Verificar suporte  c칙mera
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('cameraStatus').innerHTML = 
        '<i class="fas fa-exclamation-triangle text-warning"></i> C칙mera n칚o suportada neste navegador';
    document.getElementById('permissionPrompt').style.display = 'none';
} else {
    document.getElementById('permissionPrompt').style.display = 'block';
    document.getElementById('cameraStatus').style.display = 'none';
}

// Iniciar c칙mera
async function startCamera() {
    try {
        document.getElementById('cameraStatus').style.display = 'block';
        document.getElementById('cameraStatus').innerHTML = 
            '<i class="fas fa-circle-notch fa-spin"></i> Acessando c칙mera...';
        
        // Parar stream anterior se existir
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        // Acessar c칙mera traseira (environment) ou frontal (user)
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment', // C칙mera traseira
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        // Criar elemento video
        const preview = document.getElementById('cameraPreview');
        preview.innerHTML = '<video id="cameraVideo" autoplay playsinline></video>';
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        // Quando o v칤deo carregar
        video.onloadedmetadata = () => {
            document.getElementById('cameraStatus').style.display = 'none';
            document.getElementById('permissionPrompt').style.display = 'none';
            document.getElementById('cameraControls').style.display = 'flex';
        };
        
        hideError();
        
    } catch (error) {
        console.error('Erro ao acessar c칙mera:', error);
        showError('Erro ao acessar c칙mera: ' + (error.message || 'Permiss칚o negada ou c칙mera indispon칤vel'));
        
        document.getElementById('cameraStatus').innerHTML = 
            '<i class="fas fa-exclamation-triangle text-danger"></i> Erro ao acessar c칙mera';
        document.getElementById('permissionPrompt').style.display = 'block';
    }
}

// Parar c칙mera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    document.getElementById('cameraPreview').innerHTML = 
        '<div style="color: white; text-align: center;"><i class="fas fa-camera" style="font-size: 4rem;"></i><p>Inicie a c칙mera para come칞ar</p></div>';
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('permissionPrompt').style.display = 'block';
    document.getElementById('cameraStatus').style.display = 'none';
}

// Capturar foto
function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    if (!video) {
        showError('Inicie a c칙mera primeiro');
        return;
    }
    
    const canvas = document.getElementById('captureCanvas');
    const preview = document.getElementById('imagePreview');
    
    // Configurar canvas com tamanho do v칤deo
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Desenhar frame do v칤deo no canvas
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Converter para blob
    canvas.toBlob((blob) => {
        capturedBlob = blob;
        
        // Criar URL para preview
        const imageUrl = URL.createObjectURL(blob);
        preview.src = imageUrl;
        preview.style.display = 'block';
        
        // Converter blob para base64 para enviar
        const reader = new FileReader();
        reader.onloadend = () => {
            document.getElementById('imageBlob').value = reader.result;
        };
        reader.readAsDataURL(blob);
        
        // Mostrar formul치rio e esconder c칙mera
        document.getElementById('formSection').classList.add('active');
        document.getElementById('cameraSection').style.display = 'none';
        
        // Parar c칙mera
        stopCamera();
        
    }, 'image/jpeg', 0.9);
}

// Refazer foto
function retakePhoto() {
    capturedBlob = null;
    document.getElementById('imageBlob').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('formSection').classList.remove('active');
    document.getElementById('cameraSection').style.display = 'block';
    document.getElementById('productForm').reset();
    startCamera();
}

// Enviar produto
async function submitProduct(e) {
    e.preventDefault();
    
    if (!capturedBlob) {
        showError('Por favor, capture uma foto primeiro');
        return;
    }
    
    const form = e.target;
    const formData = new FormData(form);
    
    // Adicionar imagem como arquivo
    const timestamp = new Date().getTime();
    const filename = `produto_${timestamp}.jpg`;
    formData.append('image', capturedBlob, filename);
    
    // Remover image_blob (base64) se existir
    formData.delete('image_blob');
    
    showLoading();
    hideError();
    hideSuccess();
    
    try {
        const response = await fetch('/api/products/upload-photo/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        hideLoading();
        
        if (data.success) {
            showSuccess(`Produto "${data.product.name}" criado com sucesso!`);
            form.reset();
            
            // Limpar e voltar para c칙mera ap칩s 2 segundos
            setTimeout(() => {
                retakePhoto();
                hideSuccess();
            }, 2000);
            
        } else {
            showError(data.error || 'Erro ao salvar produto');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Erro:', error);
        showError('Erro ao enviar produto. Verifique sua conex칚o e tente novamente.');
    }
}

// Fun칞칫es auxiliares
function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function showSuccess(message) {
    const el = document.getElementById('successMessage');
    el.textContent = message;
    el.classList.add('show');
}

function hideSuccess() {
    document.getElementById('successMessage').classList.remove('show');
}

function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Limpar ao sair da p치gina
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}

