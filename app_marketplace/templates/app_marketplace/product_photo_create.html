{% extends 'app_marketplace/base.html' %}
{% load static %}

{% block title %}Cadastrar Produto por Foto - √âVORA Connect{% endblock %}

{% block extra_css %}
<style>
    .photo-container {
        max-width: 900px;
        margin: 2rem auto;
    }
    
    .step-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: none;
    }
    
    .step-card.active {
        display: block;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .step-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        position: relative;
    }
    
    .step-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .step-dot.completed {
        background: #28a745;
        color: white;
    }
    
    .step-line {
        width: 100px;
        height: 3px;
        background: #e0e0e0;
        margin: 0 -10px;
    }
    
    .step-line.completed {
        background: #28a745;
    }
    
    /* C√¢mera */
    .camera-preview {
        width: 100%;
        max-width: 100%;
        border-radius: 10px;
        background: #000;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .camera-preview video,
    .camera-preview img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
    }
    
    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-camera {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 4px solid white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    
    .btn-camera:active {
        transform: scale(0.95);
    }
    
    .btn-capture {
        background: #28a745;
        color: white;
    }
    
    .btn-retake {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-close-camera {
        background: #dc3545;
        color: white;
    }
    
    /* Formul√°rio */
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
    }
    
    .image-preview-container {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        text-align: center;
        color: white;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message, .success-message {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .error-message.show {
        display: block;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .success-message.show {
        display: block;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .permission-prompt {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .ai-analysis-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: inline-block;
        margin-bottom: 1rem;
    }
    
    .json-editor {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .extracted-data-badge {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="photo-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Cadastrar Produto por Foto
            </h1>
            <a href="{% url 'shopper_products' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
        
        <!-- Indicador de Passos -->
        <div class="step-indicator">
            <div class="step-dot active" id="step1">1</div>
            <div class="step-line" id="line1"></div>
            <div class="step-dot" id="step2">2</div>
            <div class="step-line" id="line2"></div>
            <div class="step-dot" id="step3">3</div>
        </div>
        
        <!-- Mensagens -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- PASSO 1: Captura de Foto -->
        <div class="step-card active" id="stepCard1">
            <h4 class="mb-3">üì∑ Passo 1: Tire uma foto do produto</h4>
            <p class="text-muted">Posicione o produto para capturar o r√≥tulo ou etiqueta com clareza</p>
            
            <div class="permission-prompt" id="permissionPrompt">
                <i class="fas fa-camera" style="font-size: 3rem; color: #ffc107;"></i>
                <h5>Permiss√£o de C√¢mera</h5>
                <p>Clique em "Iniciar C√¢mera" para permitir o acesso √† c√¢mera do seu dispositivo.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" onclick="startCamera()">
                        <i class="fas fa-video"></i> Iniciar C√¢mera
                    </button>
                    <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                        <i class="fas fa-images"></i> Escolher da Galeria
                    </button>
                </div>
            </div>
            
            <div class="camera-preview" id="cameraPreview">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 4rem;"></i>
                    <p>Inicie a c√¢mera ou escolha uma foto</p>
                </div>
            </div>
            
            <div class="camera-controls" id="cameraControls" style="display: none;">
                <button class="btn btn-close-camera btn-camera" onclick="stopCamera()" title="Fechar c√¢mera">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-capture btn-camera" onclick="capturePhoto()" title="Capturar foto">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            
            <canvas id="captureCanvas" style="display: none;"></canvas>
            <input type="file" id="galleryInput" accept="image/*" style="display: none;" onchange="handleGallerySelect(event)">
        </div>
        
        <!-- PASSO 2: An√°lise e Edi√ß√£o -->
        <div class="step-card" id="stepCard2">
            <h4 class="mb-3">
                <span class="ai-analysis-badge">ü§ñ An√°lise com IA</span>
                Passo 2: Confirme e ajuste os dados
            </h4>
            <p class="text-muted">A IA extraiu os dados do r√≥tulo. Revise e ajuste conforme necess√°rio.</p>
            
            <div class="image-preview-container">
                <img id="step2ImagePreview" src="" alt="Preview" class="image-preview" style="display: none;">
            </div>
            
            <!-- Formul√°rio de Dados Extra√≠dos -->
            <form id="productForm">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Nome do Produto *</label>
                            <input type="text" name="name" id="inputName" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Pre√ßo *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" name="price" id="inputPrice" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" name="brand" id="inputBrand" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select name="category" id="inputCategory" class="form-select">
                                <option value="">Selecione...</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea name="description" id="inputDescription" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Peso/Volume</label>
                            <input type="text" name="peso_volume" id="inputPesoVolume" class="form-control" placeholder="Ex: 250g, 1L, M, P">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" name="codigo_barras" id="inputCodigoBarras" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Grupo WhatsApp *</label>
                    <select name="group_id" id="inputGroupId" class="form-select" required>
                        <option value="">Selecione um grupo...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Produto ser√° adicionado ao grupo selecionado</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Empresa/Estabelecimento (Opcional)</label>
                    <select name="empresa_id" id="inputEmpresaId" class="form-select">
                        <option value="">Nenhuma</option>
                        {% for empresa in empresas %}
                        <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Campos adicionais do padr√£o √âVORA -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Subcategoria</label>
                            <input type="text" name="subcategoria" id="inputSubcategoria" class="form-control" placeholder="Ex: Fones de Ouvido, Lingerie">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">SKU Interno (√âVORA)</label>
                            <input type="text" name="sku_interno" id="inputSkuInterno" class="form-control" placeholder="EVR-XXX-XXX" readonly>
                            <small class="text-muted">Gerado automaticamente no padr√£o √âVORA</small>
                        </div>
                    </div>
                </div>
                
                <!-- Editor JSON √âVORA (Avan√ßado) -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-code"></i> JSON √âVORA Completo
                        <small class="text-muted">Edite o JSON completo no padr√£o √âVORA se necess√°rio</small>
                    </label>
                    <textarea id="jsonEditor" class="json-editor" readonly></textarea>
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleJsonEditor()">
                            <i class="fas fa-edit"></i> Editar JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="validateJson()">
                            <i class="fas fa-check"></i> Validar JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="copyJson()">
                            <i class="fas fa-copy"></i> Copiar JSON
                        </button>
                    </div>
                </div>
                
                <input type="hidden" name="image_url" id="hiddenImageUrl">
                <input type="hidden" name="currency" value="BRL">
                <input type="hidden" name="evora_json" id="hiddenEvoraJson">
                
                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                        <i class="fas fa-save"></i> Salvar Produto
                    </button>
                </div>
            </form>
        </div>
        
        <!-- PASSO 3: Confirma√ß√£o -->
        <div class="step-card" id="stepCard3">
            <h4 class="mb-3">‚úÖ Passo 3: Produto Cadastrado!</h4>
            <div class="text-center">
                <i class="fas fa-check-circle" style="font-size: 5rem; color: #28a745;"></i>
                <h5 class="mt-3" id="successProductName"></h5>
                <p class="text-muted">Produto cadastrado com sucesso!</p>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <a href="{% url 'shopper_products' %}" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Meus Produtos
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                        <i class="fas fa-plus"></i> Cadastrar Outro
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h5 class="text-white">Processando...</h5>
        <p class="text-white-50" id="loadingMessage">Analisando imagem com IA...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;
let capturedBlob = null;
let currentImageUrl = null;
let extractedData = null;
let currentStep = 1;
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Verificar suporte
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('permissionPrompt').innerHTML = 
        '<p class="text-danger">C√¢mera n√£o suportada neste navegador</p>';
}

// Iniciar c√¢mera
async function startCamera() {
    try {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        const preview = document.getElementById('cameraPreview');
        preview.innerHTML = '<video id="cameraVideo" autoplay playsinline></video>';
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            document.getElementById('permissionPrompt').style.display = 'none';
            document.getElementById('cameraControls').style.display = 'flex';
        };
        
        hideError();
    } catch (error) {
        showError('Erro ao acessar c√¢mera: ' + error.message);
    }
}

// Escolher da galeria
function selectFromGallery() {
    document.getElementById('galleryInput').click();
}

function handleGallerySelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('cameraPreview');
            preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 10px;">`;
            capturedBlob = file;
            document.getElementById('permissionPrompt').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

// Parar c√¢mera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    document.getElementById('cameraPreview').innerHTML = 
        '<div style="color: white; text-align: center;"><i class="fas fa-camera" style="font-size: 4rem;"></i><p>Inicie a c√¢mera ou escolha uma foto</p></div>';
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('permissionPrompt').style.display = 'block';
}

// Capturar foto
function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    if (!video) {
        showError('Nenhuma imagem capturada');
        return;
    }
    
    const canvas = document.getElementById('captureCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        capturedBlob = blob;
        analyzePhoto(blob);
    }, 'image/jpeg', 0.9);
}

// Analisar foto com IA
async function analyzePhoto(blob) {
    if (!capturedBlob) {
        showError('Por favor, capture uma foto primeiro');
        return;
    }
    
    showLoading('Analisando imagem com IA...');
    hideError();
    
    // Verificar se o blob √© v√°lido
    if (!blob || blob.size === 0) {
        showError('Erro: Imagem capturada est√° vazia. Tente novamente.');
        return;
    }
    
    const formData = new FormData();
    // Criar um File a partir do Blob para garantir nome e tipo
    const imageFile = new File([blob], 'captured_image.jpg', { type: 'image/jpeg' });
    formData.append('image', imageFile);
    
    console.log('Enviando imagem:', {
        size: imageFile.size,
        type: imageFile.type,
        name: imageFile.name
    });
    
    try {
        const response = await fetch('{% url "api_detect_product_by_photo" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
                // N√ÉO definir Content-Type manualmente - deixar o browser definir com boundary
            }
        });
        
        const data = await response.json();
        console.log('Resposta da API:', data);
        hideLoading();
        
        if (data.success) {
            // Armazenar JSON √âVORA completo
            extractedData = data.evora_json || {};
            currentImageUrl = data.image_url;
            
            // Preencher formul√°rio com dados simplificados
            fillForm(data.product_data || {});
            
            // Preencher campos adicionais do JSON √âVORA
            if (extractedData) {
                document.getElementById('inputSubcategoria').value = extractedData.subcategoria || '';
                document.getElementById('inputSkuInterno').value = extractedData.sku_interno || '';
            }
            
            // Mostrar preview da imagem
            const imgPreview = document.getElementById('step2ImagePreview');
            imgPreview.src = currentImageUrl;
            imgPreview.style.display = 'block';
            
            // Atualizar JSON editor com JSON √âVORA completo
            document.getElementById('jsonEditor').value = JSON.stringify(extractedData, null, 2);
            document.getElementById('hiddenImageUrl').value = currentImageUrl;
            document.getElementById('hiddenEvoraJson').value = JSON.stringify(extractedData);
            
            // Ir para passo 2
            goToStep(2);
            
        } else {
            // Mostrar erro mais detalhado
            const errorMsg = data.error || 'Erro ao analisar imagem';
            const debugInfo = data.debug ? ` (Debug: ${JSON.stringify(data.debug)})` : '';
            showError(errorMsg + debugInfo);
        }
        
    } catch (error) {
        hideLoading();
        console.error('Erro ao analisar imagem:', error);
        showError('Erro ao analisar imagem: ' + error.message);
    }
}

// Preencher formul√°rio com dados extra√≠dos
function fillForm(data) {
    document.getElementById('inputName').value = data.nome_sugerido || '';
    document.getElementById('inputBrand').value = data.marca_sugerida || '';
    document.getElementById('inputPrice').value = data.preco_visivel || '';
    document.getElementById('inputDescription').value = data.descricao_observacoes || '';
    document.getElementById('inputPesoVolume').value = data.peso_volume || '';
    document.getElementById('inputCodigoBarras').value = data.codigo_barras || '';
    document.getElementById('inputSkuInterno').value = data.sku_interno || '';
    
    // Selecionar categoria se encontrada
    if (data.categoria_sugerida) {
        const categorySelect = document.getElementById('inputCategory');
        for (let option of categorySelect.options) {
            if (option.text.toLowerCase().includes(data.categoria_sugerida.toLowerCase()) || 
                data.categoria_sugerida.toLowerCase().includes(option.text.toLowerCase())) {
                option.selected = true;
                break;
            }
        }
    }
}

// Navegar entre passos
function goToStep(step) {
    // Validar antes de avan√ßar
    if (step === 3) {
        if (!validateForm()) {
            return;
        }
        saveProduct();
        return;
    }
    
    // Atualizar indicadores
    for (let i = 1; i <= 3; i++) {
        const card = document.getElementById(`stepCard${i}`);
        const dot = document.getElementById(`step${i}`);
        
        if (i < step) {
            dot.classList.remove('active');
            dot.classList.add('completed');
            card.classList.remove('active');
        } else if (i === step) {
            dot.classList.add('active');
            dot.classList.remove('completed');
            card.classList.add('active');
        } else {
            dot.classList.remove('active', 'completed');
            card.classList.remove('active');
        }
        
        // Atualizar linhas
        if (i < step && i < 3) {
            document.getElementById(`line${i}`).classList.add('completed');
        }
    }
    
    currentStep = step;
}

// Validar formul√°rio
function validateForm() {
    const name = document.getElementById('inputName').value.trim();
    const groupId = document.getElementById('inputGroupId').value;
    
    if (!name) {
        showError('Nome do produto √© obrigat√≥rio');
        return false;
    }
    
    if (!groupId) {
        showError('Grupo WhatsApp √© obrigat√≥rio');
        return false;
    }
    
    return true;
}

// Salvar produto
async function saveProduct() {
    if (!validateForm()) {
        return;
    }
    
    showLoading('Salvando produto...');
    hideError();
    
    // Obter JSON √âVORA editado ou usar o original
    let evoraJsonData = extractedData;
    try {
        const jsonEditorValue = document.getElementById('jsonEditor').value;
        if (jsonEditorValue) {
            evoraJsonData = JSON.parse(jsonEditorValue);
        }
    } catch (e) {
        console.warn('Erro ao parsear JSON editado, usando original');
    }
    
    // Atualizar JSON √âVORA com dados do formul√°rio
    if (evoraJsonData) {
        evoraJsonData.nome_produto = document.getElementById('inputName').value.trim();
        evoraJsonData.categoria = document.getElementById('inputCategory').value || evoraJsonData.categoria;
        evoraJsonData.subcategoria = document.getElementById('inputSubcategoria').value.trim() || evoraJsonData.subcategoria;
        evoraJsonData.descricao = document.getElementById('inputDescription').value.trim() || evoraJsonData.descricao;
        evoraJsonData.codigo_barras = document.getElementById('inputCodigoBarras').value.trim() || evoraJsonData.codigo_barras;
        evoraJsonData.sku_interno = document.getElementById('inputSkuInterno').value.trim() || evoraJsonData.sku_interno;
        
        if (!evoraJsonData.caracteristicas) {
            evoraJsonData.caracteristicas = {};
        }
        evoraJsonData.caracteristicas.marca = document.getElementById('inputBrand').value.trim() || evoraJsonData.caracteristicas.marca;
    }
    
    const formData = {
        name: document.getElementById('inputName').value.trim(),
        group_id: parseInt(document.getElementById('inputGroupId').value),
        image_url: currentImageUrl,
        price: document.getElementById('inputPrice').value,
        brand: document.getElementById('inputBrand').value.trim(),
        category: document.getElementById('inputCategory').value,
        description: document.getElementById('inputDescription').value.trim(),
        codigo_barras: document.getElementById('inputCodigoBarras').value.trim(),
        sku: document.getElementById('inputSkuInterno').value.trim(),
        currency: 'BRL',
        empresa_id: document.getElementById('inputEmpresaId').value || null,
        evora_json: evoraJsonData  // JSON √âVORA completo
    };
    
    try {
        const response = await fetch('{% url "api_save_product_from_photo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            document.getElementById('successProductName').textContent = data.product.name;
            goToStep(3);
        } else {
            showError(data.error || 'Erro ao salvar produto');
        }
        
    } catch (error) {
        hideLoading();
        showError('Erro ao salvar produto: ' + error.message);
    }
}

// Toggle editor JSON
function toggleJsonEditor() {
    const editor = document.getElementById('jsonEditor');
    const isReadonly = editor.hasAttribute('readonly');
    
    if (isReadonly) {
        editor.removeAttribute('readonly');
        editor.style.background = '#fff';
        editor.style.border = '2px solid #667eea';
    } else {
        editor.setAttribute('readonly', 'true');
        editor.style.background = '#f8f9fa';
        editor.style.border = '1px solid #dee2e6';
        
        // Atualizar dados do formul√°rio se JSON foi editado
        try {
            const editedData = JSON.parse(editor.value);
            
            // Atualizar campos do formul√°rio com dados do JSON √âVORA
            if (editedData.nome_produto) {
                document.getElementById('inputName').value = editedData.nome_produto;
            }
            if (editedData.caracteristicas && editedData.caracteristicas.marca) {
                document.getElementById('inputBrand').value = editedData.caracteristicas.marca;
            }
            if (editedData.categoria) {
                const categorySelect = document.getElementById('inputCategory');
                for (let option of categorySelect.options) {
                    if (option.text.toLowerCase().includes(editedData.categoria.toLowerCase())) {
                        option.selected = true;
                        break;
                    }
                }
            }
            if (editedData.subcategoria) {
                document.getElementById('inputSubcategoria').value = editedData.subcategoria;
            }
            if (editedData.descricao) {
                document.getElementById('inputDescription').value = editedData.descricao;
            }
            if (editedData.codigo_barras) {
                document.getElementById('inputCodigoBarras').value = editedData.codigo_barras;
            }
            if (editedData.sku_interno) {
                document.getElementById('inputSkuInterno').value = editedData.sku_interno;
            }
            
            extractedData = editedData;
            document.getElementById('hiddenEvoraJson').value = JSON.stringify(editedData);
        } catch (e) {
            showError('JSON inv√°lido. Revise a sintaxe: ' + e.message);
        }
    }
}

// Validar JSON
function validateJson() {
    const editor = document.getElementById('jsonEditor');
    try {
        const json = JSON.parse(editor.value);
        showSuccess('JSON v√°lido! ‚úì');
        setTimeout(() => hideSuccess(), 2000);
    } catch (e) {
        showError('JSON inv√°lido: ' + e.message);
    }
}

// Copiar JSON
function copyJson() {
    const editor = document.getElementById('jsonEditor');
    editor.select();
    document.execCommand('copy');
    showSuccess('JSON copiado para a √°rea de transfer√™ncia!');
    setTimeout(() => hideSuccess(), 2000);
}

// Resetar formul√°rio
function resetForm() {
    currentStep = 1;
    capturedBlob = null;
    currentImageUrl = null;
    extractedData = null;
    
    document.getElementById('productForm').reset();
    document.getElementById('jsonEditor').value = '';
    document.getElementById('hiddenEvoraJson').value = '';
    document.getElementById('step2ImagePreview').style.display = 'none';
    
    // Resetar indicadores de passos
    for (let i = 1; i <= 3; i++) {
        document.getElementById(`step${i}`).classList.remove('active', 'completed');
        document.getElementById(`line${i}`).classList.remove('completed');
    }
    document.getElementById('step1').classList.add('active');
    
    stopCamera();
    goToStep(1);
}

// Fun√ß√µes auxiliares
function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function showSuccess(message) {
    const el = document.getElementById('successMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideSuccess() {
    document.getElementById('successMessage').classList.remove('show');
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Limpar ao sair
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}

