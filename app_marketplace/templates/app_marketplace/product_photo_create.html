{% extends 'app_marketplace/base.html' %}
{% load static %}

{% block title %}Cadastrar Produto por Foto - √âVORA Connect{% endblock %}

{% block extra_css %}
<style>
    .photo-container {
        max-width: 1000px;
        margin: 2rem auto;
    }
    
    .step-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: none;
    }
    
    .step-card.active {
        display: block;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .step-dot {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        position: relative;
        transition: all 0.3s;
    }
    
    .step-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.1);
    }
    
    .step-dot.completed {
        background: #28a745;
        color: white;
    }
    
    .step-line {
        width: 80px;
        height: 3px;
        background: #e0e0e0;
        transition: all 0.3s;
    }
    
    .step-line.completed {
        background: #28a745;
    }
    
    .step-label {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.75rem;
        color: #666;
        font-weight: normal;
    }
    
    .step-dot.active .step-label {
        color: #667eea;
        font-weight: bold;
    }
    
    /* C√¢mera */
    .camera-preview {
        width: 100%;
        max-width: 100%;
        border-radius: 10px;
        background: #000;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .camera-preview video,
    .camera-preview img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
    }
    
    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-camera {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 4px solid white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .btn-camera:active {
        transform: scale(0.95);
    }
    
    .btn-capture {
        background: #28a745;
        color: white;
    }
    
    .btn-close-camera {
        background: #dc3545;
        color: white;
    }
    
    /* Grid de Fotos */
    .photos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .photo-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        aspect-ratio: 1;
    }
    
    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .photo-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .photo-item .remove-btn:hover {
        background: rgba(220, 53, 69, 1);
        transform: scale(1.1);
    }
    
    /* Loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        text-align: center;
        color: white;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message, .success-message {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .error-message.show {
        display: block;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .success-message.show {
        display: block;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .permission-prompt {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .verification-result {
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
        text-align: center;
    }
    
    .verification-result.success {
        background: #d4edda;
        border: 2px solid #28a745;
        color: #155724;
    }
    
    .verification-result.warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
    }
    
    .json-editor {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        width: 100%;
    }
    
    .image-preview-container {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
        margin: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="photo-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Cadastrar Produto por Foto
            </h1>
            <a href="{% url 'shopper_products' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
        
        <!-- Indicador de Passos (3 etapas) -->
        <div class="step-indicator">
            <div class="step-dot active" id="step1">
                1
                <span class="step-label">Capturar</span>
            </div>
            <div class="step-line" id="line1"></div>
            <div class="step-dot" id="step2">
                2
                <span class="step-label">Analisar</span>
            </div>
            <div class="step-line" id="line2"></div>
            <div class="step-dot" id="step3">
                3
                <span class="step-label">Salvar</span>
            </div>
        </div>
        
        <!-- Mensagens -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- ETAPA 1: Captura de M√∫ltiplas Fotos -->
        <div class="step-card active" id="stepCard1">
            <h4 class="mb-3">üì∑ Etapa 1: Capture fotos do produto</h4>
            <p class="text-muted">Capture m√∫ltiplas fotos do mesmo produto. Voc√™ pode remover ou adicionar mais fotos antes de analisar.</p>
            
            <div class="permission-prompt" id="permissionPrompt">
                <i class="fas fa-camera" style="font-size: 3rem; color: #ffc107;"></i>
                <h5>Permiss√£o de C√¢mera</h5>
                <p>Clique em "Iniciar C√¢mera" para permitir o acesso √† c√¢mera do seu dispositivo.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" id="btnStartCamera" onclick="console.log('[BUTTON_CLICK] onclick disparado'); if(typeof window.startCamera === 'function') { window.startCamera(); } else { console.error('[BUTTON_CLICK] window.startCamera n√£o encontrado'); alert('Fun√ß√£o n√£o dispon√≠vel. Verifique o console.'); }">
                        <i class="fas fa-video"></i> Iniciar C√¢mera
                    </button>
                    <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                        <i class="fas fa-images"></i> Escolher da Galeria
                    </button>
                </div>
            </div>
            
            <div class="camera-preview" id="cameraPreview">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 4rem;"></i>
                    <p>Inicie a c√¢mera ou escolha uma foto</p>
                </div>
            </div>
            
            <div class="camera-controls" id="cameraControls" style="display: none;">
                <button class="btn btn-close-camera btn-camera" onclick="stopCamera()" title="Fechar c√¢mera">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-capture btn-camera" onclick="capturePhoto()" title="Capturar foto">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            
            <!-- Grid de Fotos Capturadas -->
            <div id="photosGridContainer" style="display: none;">
                <h5 class="mt-4 mb-3">Fotos Capturadas (<span id="photoCount">0</span>)</h5>
                <div class="photos-grid" id="photosGrid"></div>
                <div class="d-flex gap-2 justify-content-center mt-3">
                    <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                        <i class="fas fa-plus"></i> Adicionar Mais Fotos
                    </button>
                    <button class="btn btn-primary" onclick="analyzeComplete()" id="btnAnalyze" disabled>
                        <i class="fas fa-robot"></i> Analisar Produto
                    </button>
                </div>
            </div>
            
            <canvas id="captureCanvas" style="display: none;"></canvas>
            <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;" onchange="handleGallerySelect(event)">
        </div>
        
        <!-- ETAPA 2: An√°lise Completa -->
        <div class="step-card" id="stepCard2">
            <h4 class="mb-3">ü§ñ Etapa 2: An√°lise completa com IA</h4>
            <p class="text-muted">Gerando JSON completo do produto com todas as informa√ß√µes extra√≠das...</p>
            
            <div id="analysisLoading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="mt-3" id="analysisProgress">Analisando imagens e gerando dados do produto...</p>
            </div>
            
            <div id="analysisResult" style="display: none;">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> An√°lise completa conclu√≠da!
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(3)">
                        <i class="fas fa-eye"></i> Revisar e Salvar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ETAPA 3: Revis√£o e Salvamento -->
        <div class="step-card" id="stepCard3">
            <h4 class="mb-3">‚úÖ Etapa 3: Revisar e Salvar</h4>
            <p class="text-muted">Revise os dados extra√≠dos e salve o produto no banco de dados.</p>
            
            <!-- Preview de Imagens -->
            <div id="imagesPreviewContainer" class="mb-4">
                <h5>Imagens do Produto</h5>
                <div class="image-preview-container" id="imagesPreview"></div>
            </div>
            
            <!-- Formul√°rio de Dados -->
            <form id="productForm">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nome do Produto *</label>
                            <input type="text" name="name" id="inputName" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" name="brand" id="inputBrand" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Pre√ßo *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" name="price" id="inputPrice" class="form-control" 
                                       step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select name="category" id="inputCategory" class="form-select">
                                <option value="">Selecione...</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" name="codigo_barras" id="inputCodigoBarras" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Estoque</label>
                            <input type="number" name="estoque" id="inputEstoque" class="form-control" 
                                   min="0" placeholder="Quantidade dispon√≠vel">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea name="description" id="inputDescription" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Grupo WhatsApp</label>
                    <select name="group_id" id="inputGroupId" class="form-select">
                        <option value="">Selecione um grupo...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Editor JSON -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-code"></i> JSON Completo (modelo.json)
                        <small class="text-muted">Edite se necess√°rio</small>
                    </label>
                    <textarea id="jsonEditor" class="json-editor"></textarea>
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleJsonEditor()">
                            <i class="fas fa-edit"></i> Editar JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="validateJson()">
                            <i class="fas fa-check"></i> Validar JSON
                        </button>
                    </div>
                </div>
                
                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save"></i> Salvar no Banco
                    </button>
                </div>
            </form>
        </div>
        
        <!-- ETAPA 5: Confirma√ß√£o -->
        <div class="step-card" id="stepCard5" style="display: none;">
            <h4 class="mb-3">‚úÖ Produto Cadastrado!</h4>
            <div class="text-center">
                <i class="fas fa-check-circle" style="font-size: 5rem; color: #28a745;"></i>
                <h5 class="mt-3" id="successProductName"></h5>
                <p class="text-muted">Produto cadastrado com sucesso!</p>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <a href="{% url 'shopper_products' %}" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Meus Produtos
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                        <i class="fas fa-plus"></i> Cadastrar Outro
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h5 class="text-white">Processando...</h5>
        <p class="text-white-50" id="loadingMessage">Aguarde...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('[CAMERA_SCRIPT] ========== SCRIPT CARREGADO ==========');
console.log('[CAMERA_SCRIPT] Timestamp:', new Date().toISOString());
console.log('[CAMERA_SCRIPT] URL:', window.location.href);
console.log('[CAMERA_SCRIPT] User Agent:', navigator.userAgent);

// Aguardar DOM estar pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('[CAMERA_SCRIPT] ‚úÖ DOM carregado');
    initializeCamera();
});

// Fallback para caso DOMContentLoaded j√° tenha sido disparado
if (document.readyState === 'loading') {
    console.log('[CAMERA_SCRIPT] DOM ainda carregando, aguardando DOMContentLoaded...');
} else {
    console.log('[CAMERA_SCRIPT] DOM j√° carregado, inicializando imediatamente...');
    initializeCamera();
}

function initializeCamera() {
    console.log('[CAMERA_SCRIPT] ========== INICIALIZANDO C√ÇMERA ==========');
    
    // Vari√°veis globais
    console.log('[CAMERA_INIT] Inicializando vari√°veis globais...');
    window.stream = null;
    window.capturedPhotos = [];  // Array de {id, blob, preview}
    window.currentStep = 1;
    window.produtoJson = null;
    window.imageUrls = [];
    window.imagePaths = [];

    // Verificar CSRF token
    const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfElement) {
        window.csrfToken = csrfElement.value;
        console.log('[CAMERA_INIT] CSRF token encontrado:', window.csrfToken ? 'SIM' : 'N√ÉO');
    } else {
        console.warn('[CAMERA_INIT] CSRF token n√£o encontrado');
        window.csrfToken = '';
    }

    window.photoIdCounter = 0;

    // Verificar elementos DOM
    console.log('[CAMERA_INIT] Verificando elementos DOM...');
    const permissionPromptEl = document.getElementById('permissionPrompt');
    const cameraPreviewEl = document.getElementById('cameraPreview');
    const cameraControlsEl = document.getElementById('cameraControls');

    console.log('[CAMERA_INIT] permissionPrompt:', permissionPromptEl ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO');
    console.log('[CAMERA_INIT] cameraPreview:', cameraPreviewEl ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO');
    console.log('[CAMERA_INIT] cameraControls:', cameraControlsEl ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO');

    // Verificar suporte
    console.log('[CAMERA_INIT] Verificando suporte de m√≠dia...');
    console.log('[CAMERA_INIT] navigator.mediaDevices:', navigator.mediaDevices ? 'EXISTE' : 'N√ÉO EXISTE');
    console.log('[CAMERA_INIT] navigator.mediaDevices.getUserMedia:', navigator.mediaDevices?.getUserMedia ? 'EXISTE' : 'N√ÉO EXISTE');

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error('[CAMERA_INIT] ‚ùå API de m√≠dia n√£o suportada');
        if (permissionPromptEl) {
            permissionPromptEl.innerHTML = 
                '<p class="text-danger">C√¢mera n√£o suportada neste navegador. Use Chrome, Firefox ou Safari atualizado.</p>';
        }
    } else {
        console.log('[CAMERA_INIT] ‚úÖ API de m√≠dia suportada');
    }

    // Verificar contexto seguro (HTTPS ou localhost)
    console.log('[CAMERA_INIT] Verificando contexto seguro...');
    console.log('[CAMERA_INIT] window.isSecureContext:', window.isSecureContext);
    console.log('[CAMERA_INIT] location.protocol:', location.protocol);
    console.log('[CAMERA_INIT] location.hostname:', location.hostname);

    window.isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    console.log('[CAMERA_INIT] isSecureContext:', window.isSecureContext);

    if (!window.isSecureContext) {
        console.warn('[CAMERA_INIT] ‚ö†Ô∏è Contexto n√£o seguro - getUserMedia requer HTTPS');
        if (permissionPromptEl) {
            permissionPromptEl.innerHTML = 
                '<p class="text-warning">‚ö†Ô∏è A c√¢mera requer conex√£o HTTPS. Certifique-se de estar acessando via HTTPS.</p>';
        }
    } else {
        console.log('[CAMERA_INIT] ‚úÖ Contexto seguro detectado');
    }

    // Verificar permiss√µes existentes
    if (navigator.permissions && navigator.permissions.query) {
        console.log('[CAMERA_INIT] Verificando permiss√µes de c√¢mera...');
        navigator.permissions.query({ name: 'camera' }).then(result => {
            console.log('[CAMERA_INIT] Status de permiss√£o de c√¢mera:', result.state);
            if (result.state === 'granted') {
                console.log('[CAMERA_INIT] ‚úÖ Permiss√£o de c√¢mera j√° concedida');
            } else if (result.state === 'denied') {
                console.warn('[CAMERA_INIT] ‚ö†Ô∏è Permiss√£o de c√¢mera negada');
            } else {
                console.log('[CAMERA_INIT] ‚è≥ Permiss√£o de c√¢mera pendente');
            }
        }).catch(err => {
            console.warn('[CAMERA_INIT] N√£o foi poss√≠vel verificar permiss√µes:', err);
        });
    }

    // Adicionar event listeners aos bot√µes como fallback
    console.log('[CAMERA_INIT] Adicionando event listeners aos bot√µes...');
    
    // Procurar bot√£o de v√°rias formas
    let startCameraBtn = document.querySelector('button[onclick*="startCamera"]');
    if (!startCameraBtn) {
        startCameraBtn = document.querySelector('button.btn-primary');
    }
    if (!startCameraBtn) {
        // Procurar pelo texto do bot√£o
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            if (btn.textContent.includes('Iniciar C√¢mera') || btn.textContent.includes('startCamera')) {
                startCameraBtn = btn;
            }
        });
    }
    
    if (startCameraBtn) {
        console.log('[CAMERA_INIT] ‚úÖ Bot√£o de iniciar c√¢mera encontrado:', {
            tagName: startCameraBtn.tagName,
            className: startCameraBtn.className,
            onclick: startCameraBtn.getAttribute('onclick'),
            textContent: startCameraBtn.textContent.trim()
        });
        
        // Remover onclick antigo e adicionar event listener
        const oldOnclick = startCameraBtn.getAttribute('onclick');
        startCameraBtn.removeAttribute('onclick');
        console.log('[CAMERA_INIT] onclick removido:', oldOnclick);
        
        startCameraBtn.addEventListener('click', function(e) {
            console.log('[CAMERA_INIT] ========== BOT√ÉO CLICADO ==========');
            console.log('[CAMERA_INIT] Timestamp:', new Date().toISOString());
            console.log('[CAMERA_INIT] Event:', e);
            e.preventDefault();
            e.stopPropagation();
            
            console.log('[CAMERA_INIT] Verificando se window.startCamera existe...');
            console.log('[CAMERA_INIT] typeof window.startCamera:', typeof window.startCamera);
            console.log('[CAMERA_INIT] window.startCamera:', window.startCamera);
            
            if (typeof window.startCamera === 'function') {
                console.log('[CAMERA_INIT] ‚úÖ Fun√ß√£o startCamera encontrada, chamando...');
                try {
                    window.startCamera();
                    console.log('[CAMERA_INIT] ‚úÖ startCamera() chamado com sucesso');
                } catch (error) {
                    console.error('[CAMERA_INIT] ‚ùå Erro ao chamar startCamera():', error);
                    showError('Erro ao iniciar c√¢mera: ' + error.message);
                }
            } else {
                console.error('[CAMERA_INIT] ‚ùå Fun√ß√£o startCamera n√£o encontrada!');
                console.error('[CAMERA_INIT] window.startCamera:', window.startCamera);
                console.error('[CAMERA_INIT] Tentando chamar startCamera diretamente...');
                try {
                    if (typeof startCamera === 'function') {
                        console.log('[CAMERA_INIT] startCamera encontrado sem window, chamando...');
                        startCamera();
                    } else {
                        showError('Fun√ß√£o startCamera n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
                    }
                } catch (err) {
                    console.error('[CAMERA_INIT] Erro ao chamar startCamera diretamente:', err);
                    showError('Erro: ' + err.message);
                }
            }
        }, { capture: true });
        
        console.log('[CAMERA_INIT] ‚úÖ Event listener adicionado ao bot√£o');
    } else {
        console.warn('[CAMERA_INIT] ‚ö†Ô∏è Bot√£o de iniciar c√¢mera n√£o encontrado');
        console.warn('[CAMERA_INIT] Tentando novamente ap√≥s 1 segundo...');
        setTimeout(() => {
            const btn = document.querySelector('button[onclick*="startCamera"]') || 
                       document.querySelector('button.btn-primary');
            if (btn) {
                console.log('[CAMERA_INIT] ‚úÖ Bot√£o encontrado ap√≥s delay');
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof window.startCamera === 'function') {
                        window.startCamera();
                    }
                });
            }
        }, 1000);
    }
    
    // Verificar se a fun√ß√£o est√° dispon√≠vel globalmente
    console.log('[CAMERA_INIT] Verificando disponibilidade global de startCamera...');
    console.log('[CAMERA_INIT] window.startCamera:', typeof window.startCamera);
    console.log('[CAMERA_INIT] window.stopCamera:', typeof window.stopCamera);
    console.log('[CAMERA_INIT] window.selectFromGallery:', typeof window.selectFromGallery);
    
    // Tornar fun√ß√£o dispon√≠vel globalmente tamb√©m sem window (fallback)
    if (typeof window.startCamera === 'function') {
        window.startCameraGlobal = window.startCamera;
        console.log('[CAMERA_INIT] ‚úÖ startCameraGlobal criado como fallback');
    }

    console.log('[CAMERA_INIT] ‚úÖ Inicializa√ß√£o completa');
}

// ========== ETAPA 1: CAPTURA ==========

// Iniciar c√¢mera - Tornar global
window.startCamera = async function startCamera() {
    console.log('[CAMERA_START] ========== INICIANDO C√ÇMERA ==========');
    console.log('[CAMERA_START] Timestamp:', new Date().toISOString());
    console.log('[CAMERA_START] Stack trace:', new Error().stack);
    
    // Verificar elementos DOM
    console.log('[CAMERA_START] Verificando elementos DOM...');
    const permissionPrompt = document.getElementById('permissionPrompt');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraControls = document.getElementById('cameraControls');
    
    console.log('[CAMERA_START] permissionPrompt:', permissionPrompt ? '‚úÖ ENCONTRADO' : '‚ùå N√ÉO ENCONTRADO');
    console.log('[CAMERA_START] cameraPreview:', cameraPreview ? '‚úÖ ENCONTRADO' : '‚ùå N√ÉO ENCONTRADO');
    console.log('[CAMERA_START] cameraControls:', cameraControls ? '‚úÖ ENCONTRADO' : '‚ùå N√ÉO ENCONTRADO');
    
    if (!permissionPrompt || !cameraPreview || !cameraControls) {
        console.error('[CAMERA_START] ‚ùå Elementos DOM n√£o encontrados!');
        showError('Erro: Elementos da p√°gina n√£o encontrados. Recarregue a p√°gina.');
        return;
    }
    
    try {
        // Verificar suporte novamente
        console.log('[CAMERA_START] Verificando suporte de API...');
        console.log('[CAMERA_START] navigator.mediaDevices:', navigator.mediaDevices ? '‚úÖ EXISTE' : '‚ùå N√ÉO EXISTE');
        console.log('[CAMERA_START] navigator.mediaDevices.getUserMedia:', navigator.mediaDevices?.getUserMedia ? '‚úÖ EXISTE' : '‚ùå N√ÉO EXISTE');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('[CAMERA_START] ‚ùå API de m√≠dia n√£o suportada');
            throw new Error('API de m√≠dia n√£o suportada neste navegador');
        }
        
        // Verificar contexto seguro
        console.log('[CAMERA_START] Verificando contexto seguro...');
        console.log('[CAMERA_START] isSecureContext:', window.isSecureContext);
        
        if (!window.isSecureContext) {
            console.error('[CAMERA_START] ‚ùå Contexto n√£o seguro');
            throw new Error('Conex√£o n√£o segura. A c√¢mera requer HTTPS.');
        }
        
        // Verificar stream anterior
        console.log('[CAMERA_START] Verificando stream anterior...');
        console.log('[CAMERA_START] stream atual:', window.stream ? 'EXISTE' : 'N√ÉO EXISTE');
        
        // Mostrar indicador de carregamento
        console.log('[CAMERA_START] Mostrando indicador de carregamento...');
        permissionPrompt.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Acessando c√¢mera...</p></div>';
        
        // Parar stream anterior se existir
        if (window.stream) {
            console.log('[CAMERA_START] Parando stream anterior...');
            const tracks = window.stream.getTracks();
            console.log('[CAMERA_START] Tracks encontrados:', tracks.length);
            tracks.forEach((track, index) => {
                console.log(`[CAMERA_START] Parando track ${index}:`, track.kind, track.label);
                track.stop();
            });
            window.stream = null;
            console.log('[CAMERA_START] ‚úÖ Stream anterior parado');
        }
        
        // Listar dispositivos dispon√≠veis
        console.log('[CAMERA_START] Listando dispositivos de m√≠dia dispon√≠veis...');
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            console.log('[CAMERA_START] Dispositivos de v√≠deo encontrados:', videoDevices.length);
            videoDevices.forEach((device, index) => {
                console.log(`[CAMERA_START]   Dispositivo ${index + 1}:`, device.label || 'Sem nome', '- ID:', device.deviceId);
            });
        } catch (enumError) {
            console.warn('[CAMERA_START] N√£o foi poss√≠vel listar dispositivos:', enumError);
        }
        
        // Solicitar acesso √† c√¢mera
        console.log('[CAMERA_START] Solicitando acesso √† c√¢mera...');
        console.log('[CAMERA_START] Configura√ß√£o solicitada:', {
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        const startTime = Date.now();
        window.stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment', // C√¢mera traseira
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        const requestTime = Date.now() - startTime;
        console.log('[CAMERA_START] ‚úÖ Acesso concedido em', requestTime, 'ms');
        console.log('[CAMERA_START] Stream recebido:', window.stream ? '‚úÖ SIM' : '‚ùå N√ÉO');
        
        if (window.stream) {
            const tracks = window.stream.getTracks();
            console.log('[CAMERA_START] Tracks no stream:', tracks.length);
            tracks.forEach((track, index) => {
                console.log(`[CAMERA_START]   Track ${index + 1}:`, {
                    kind: track.kind,
                    label: track.label,
                    enabled: track.enabled,
                    readyState: track.readyState,
                    settings: track.getSettings()
                });
            });
        }
        
        // Configurar preview
        console.log('[CAMERA_START] Configurando preview de v√≠deo...');
        cameraPreview.innerHTML = '<video id="cameraVideo" autoplay playsinline muted></video>';
        
        const video = document.getElementById('cameraVideo');
        console.log('[CAMERA_START] Elemento de v√≠deo criado:', video ? '‚úÖ SIM' : '‚ùå N√ÉO');
        
        if (!video) {
            throw new Error('N√£o foi poss√≠vel criar elemento de v√≠deo');
        }
        
        console.log('[CAMERA_START] Atribuindo stream ao v√≠deo...');
        video.srcObject = window.stream;
        console.log('[CAMERA_START] ‚úÖ Stream atribu√≠do ao v√≠deo');
        
        // Timeout de seguran√ßa - se n√£o carregar em 5 segundos, mostrar erro
        let timeoutId = setTimeout(() => {
            if (!video.videoWidth && !video.videoHeight) {
                console.error('[CAMERA_START] ‚ùå Timeout - v√≠deo n√£o carregou ap√≥s 5 segundos');
                console.error('[CAMERA_START] Estado do v√≠deo:', {
                    videoWidth: video.videoWidth,
                    videoHeight: video.videoHeight,
                    readyState: video.readyState,
                    paused: video.paused,
                    srcObject: video.srcObject ? 'EXISTE' : 'N√ÉO EXISTE'
                });
                showError('A c√¢mera n√£o respondeu. Tente novamente.');
                stopCamera();
            } else {
                console.log('[CAMERA_START] ‚úÖ V√≠deo carregou dentro do timeout');
            }
        }, 5000);
        
        // Aguardar v√≠deo carregar
        console.log('[CAMERA_START] Aguardando carregamento do v√≠deo...');
        video.onloadedmetadata = () => {
            clearTimeout(timeoutId);
            console.log('[CAMERA_START] ‚úÖ V√≠deo carregado!');
            console.log('[CAMERA_START] Dimens√µes:', video.videoWidth, 'x', video.videoHeight);
            console.log('[CAMERA_START] Dura√ß√£o:', video.duration);
            console.log('[CAMERA_START] srcObject:', video.srcObject ? '‚úÖ EXISTE' : '‚ùå N√ÉO EXISTE');
            console.log('[CAMERA_START] readyState:', video.readyState);
            
            permissionPrompt.style.display = 'none';
            cameraControls.style.display = 'flex';
            console.log('[CAMERA_START] ‚úÖ Controles de c√¢mera exibidos');
            hideError();
        };
        
        // Tratamento de erros do v√≠deo
        video.onerror = (e) => {
            clearTimeout(timeoutId);
            console.error('[CAMERA_START] ‚ùå Erro no elemento de v√≠deo:', e);
            console.error('[CAMERA_START] Erro detalhado:', {
                code: video.error?.code,
                message: video.error?.message
            });
            showError('Erro ao exibir v√≠deo da c√¢mera');
        };
        
        // Verificar se v√≠deo est√° realmente reproduzindo
        video.onplay = () => {
            console.log('[CAMERA_START] ‚úÖ V√≠deo come√ßou a reproduzir');
        };
        
        video.onplaying = () => {
            console.log('[CAMERA_START] ‚úÖ V√≠deo est√° reproduzindo');
        };
        
        video.onpause = () => {
            console.warn('[CAMERA_START] ‚ö†Ô∏è V√≠deo pausado');
        };
        
        video.onstalled = () => {
            console.warn('[CAMERA_START] ‚ö†Ô∏è V√≠deo travado');
        };
        
    } catch (error) {
        console.error('[CAMERA_START] ========== ERRO AO ACESSAR C√ÇMERA ==========');
        console.error('[CAMERA_START] Tipo de erro:', error.name);
        console.error('[CAMERA_START] Mensagem:', error.message);
        console.error('[CAMERA_START] Stack:', error.stack);
        console.error('[CAMERA_START] Erro completo:', error);
        
        let errorMessage = 'Erro ao acessar c√¢mera: ';
        
        // Mensagens de erro mais espec√≠ficas
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            console.error('[CAMERA_START] ‚ùå Permiss√£o negada pelo usu√°rio');
            errorMessage = 'Permiss√£o de c√¢mera negada. Por favor, permita o acesso √† c√¢mera nas configura√ß√µes do navegador.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            console.error('[CAMERA_START] ‚ùå Nenhuma c√¢mera encontrada');
            errorMessage = 'Nenhuma c√¢mera encontrada. Verifique se h√° uma c√¢mera conectada ao dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            console.error('[CAMERA_START] ‚ùå C√¢mera n√£o pode ser lida (provavelmente em uso)');
            errorMessage = 'C√¢mera est√° sendo usada por outro aplicativo. Feche outros apps que usam a c√¢mera e tente novamente.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
            console.warn('[CAMERA_START] ‚ö†Ô∏è Configura√ß√£o n√£o suportada, tentando alternativa...');
            errorMessage = 'Configura√ß√µes da c√¢mera n√£o suportadas. Tentando configura√ß√£o alternativa...';
            // Tentar com configura√ß√£o mais simples
            try {
                console.log('[CAMERA_START] Tentando com configura√ß√£o simples (video: true)...');
                window.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                console.log('[CAMERA_START] ‚úÖ Configura√ß√£o alternativa funcionou!');
                const video = document.getElementById('cameraVideo');
                if (video) {
                    video.srcObject = window.stream;
                    permissionPrompt.style.display = 'none';
                    cameraControls.style.display = 'flex';
                    hideError();
                    console.log('[CAMERA_START] ‚úÖ C√¢mera iniciada com configura√ß√£o alternativa');
                    return;
                } else {
                    console.error('[CAMERA_START] ‚ùå Elemento de v√≠deo n√£o encontrado ap√≥s retry');
                }
            } catch (retryError) {
                console.error('[CAMERA_START] ‚ùå Retry tamb√©m falhou:', retryError);
                console.error('[CAMERA_START] Tipo de erro no retry:', retryError.name);
                console.error('[CAMERA_START] Mensagem do retry:', retryError.message);
                errorMessage = 'Erro ao acessar c√¢mera: ' + retryError.message;
            }
        } else {
            console.error('[CAMERA_START] ‚ùå Erro desconhecido:', error.name);
            errorMessage += error.message;
        }
        
        console.error('[CAMERA_START] Exibindo mensagem de erro ao usu√°rio:', errorMessage);
        showError(errorMessage);
        
        // Restaurar bot√£o de iniciar c√¢mera
        permissionPrompt.innerHTML = `
            <i class="fas fa-camera" style="font-size: 3rem; color: #ffc107;"></i>
            <h5>Permiss√£o de C√¢mera</h5>
            <p>Clique em "Iniciar C√¢mera" para permitir o acesso √† c√¢mera do seu dispositivo.</p>
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-primary" onclick="startCamera()">
                    <i class="fas fa-video"></i> Iniciar C√¢mera
                </button>
                <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                    <i class="fas fa-images"></i> Escolher da Galeria
                </button>
            </div>
        `;
    }
}

// Parar c√¢mera - Tornar global
window.stopCamera = function stopCamera() {
    console.log('[CAMERA_STOP] ========== PARANDO C√ÇMERA ==========');
    console.log('[CAMERA_STOP] Timestamp:', new Date().toISOString());
    
    if (window.stream) {
        console.log('[CAMERA_STOP] Stream existe, parando tracks...');
        const tracks = window.stream.getTracks();
        console.log('[CAMERA_STOP] N√∫mero de tracks:', tracks.length);
        tracks.forEach((track, index) => {
            console.log(`[CAMERA_STOP] Parando track ${index + 1}:`, {
                kind: track.kind,
                label: track.label,
                enabled: track.enabled,
                readyState: track.readyState
            });
            track.stop();
            console.log(`[CAMERA_STOP] ‚úÖ Track ${index + 1} parado`);
            });
            window.stream = null;
            console.log('[CAMERA_STOP] ‚úÖ Stream limpo');
    } else {
        console.log('[CAMERA_STOP] Nenhum stream ativo');
    }
    
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraControls = document.getElementById('cameraControls');
    const permissionPrompt = document.getElementById('permissionPrompt');
    
    console.log('[CAMERA_STOP] Elementos DOM:', {
        cameraPreview: cameraPreview ? '‚úÖ' : '‚ùå',
        cameraControls: cameraControls ? '‚úÖ' : '‚ùå',
        permissionPrompt: permissionPrompt ? '‚úÖ' : '‚ùå'
    });
    
    if (cameraPreview) {
        cameraPreview.innerHTML = 
            '<div style="color: white; text-align: center;"><i class="fas fa-camera" style="font-size: 4rem;"></i><p>Inicie a c√¢mera ou escolha uma foto</p></div>';
        console.log('[CAMERA_STOP] ‚úÖ Preview resetado');
    }
    
    if (cameraControls) {
        cameraControls.style.display = 'none';
        console.log('[CAMERA_STOP] ‚úÖ Controles ocultados');
    }
    
    if (permissionPrompt) {
        permissionPrompt.style.display = 'block';
        console.log('[CAMERA_STOP] ‚úÖ Prompt de permiss√£o exibido');
    }
    
    console.log('[CAMERA_STOP] ‚úÖ C√¢mera parada com sucesso');
}

// Escolher da galeria - Tornar global
window.selectFromGallery = function selectFromGallery() {
    document.getElementById('galleryInput').click();
}

function handleGallerySelect(event) {
    const files = Array.from(event.target.files);
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            addPhotoFromFile(file);
        }
    });
    // Limpar input para permitir selecionar o mesmo arquivo novamente
    event.target.value = '';
}

// Adicionar foto do arquivo
function addPhotoFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const blob = file;
        addPhotoToArray(blob, e.target.result);
    };
    reader.readAsDataURL(file);
}

// Capturar foto da c√¢mera
function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    if (!video) {
        showError('Nenhuma imagem capturada');
        return;
    }
    
    const canvas = document.getElementById('captureCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        const preview = URL.createObjectURL(blob);
        addPhotoToArray(blob, preview);
    }, 'image/jpeg', 0.9);
}

// Adicionar foto ao array
function addPhotoToArray(blob, preview) {
    const photo = {
        id: window.photoIdCounter++,
        blob: blob,
        preview: preview
    };
    window.capturedPhotos.push(photo);
    renderPhotoGrid();
    updateAnalyzeButton();
}

// Remover foto
function removePhoto(id) {
    window.capturedPhotos = window.capturedPhotos.filter(p => p.id !== id);
    renderPhotoGrid();
    updateAnalyzeButton();
}

// Renderizar grid de fotos
function renderPhotoGrid() {
    const grid = document.getElementById('photosGrid');
    const container = document.getElementById('photosGridContainer');
    const count = document.getElementById('photoCount');
    
    if (window.capturedPhotos.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    count.textContent = window.capturedPhotos.length;
    
    grid.innerHTML = window.capturedPhotos.map(photo => `
        <div class="photo-item">
            <img src="${photo.preview}" alt="Foto ${photo.id}">
            <button class="remove-btn" onclick="removePhoto(${photo.id})" title="Remover foto">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// Atualizar bot√£o de analisar
function updateAnalyzeButton() {
    const btn = document.getElementById('btnAnalyze');
    if (btn) {
        btn.disabled = window.capturedPhotos.length === 0;
    }
}

// ========== ETAPA 2: AN√ÅLISE COMPLETA ==========

// An√°lise completa
async function analyzeComplete() {
    console.log('[ANALISE_COMPLETA] Iniciando an√°lise completa');
    console.log('[ANALISE_COMPLETA] Fotos capturadas:', window.capturedPhotos.length);
    
    if (window.capturedPhotos.length === 0) {
        console.error('[ANALISE_COMPLETA] Nenhuma foto capturada');
        showError('Capture pelo menos uma foto antes de analisar');
        return;
    }
    
    goToStep(2);
    showLoading('Realizando an√°lise completa com IA...');
    hideError();
    
    // Fazer upload das fotos diretamente
    const formData = new FormData();
    window.capturedPhotos.forEach((photo, index) => {
        const file = new File([photo.blob], `photo_${photo.id}.jpg`, { type: 'image/jpeg' });
        formData.append('images', file);
        console.log(`[ANALISE_COMPLETA] Adicionando foto ${index + 1}/${window.capturedPhotos.length}: photo_${photo.id}.jpg`);
    });
    
    console.log('[ANALISE_COMPLETA] Enviando requisi√ß√£o para an√°lise completa...');
    let response;
    try {
        response = await fetch('{% url "api_analise_completa" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': window.csrfToken
            }
        });
        console.log('[ANALISE_COMPLETA] Resposta recebida, status:', response.status);
    } catch (error) {
        console.error('[ANALISE_COMPLETA] Erro ao fazer upload:', error);
        hideLoading();
        showError('Erro ao fazer upload: ' + error.message);
        goToStep(1);
        return;
    }
    
    try {
        const data = await response.json();
        console.log('[ANALISE_COMPLETA] Dados recebidos:', {
            success: data.success,
            has_produto_json: !!data.produto_json,
            image_urls: data.image_urls?.length || 0,
            image_paths: data.image_paths?.length || 0
        });
        hideLoading();
        
        if (data.success) {
            window.produtoJson = data.produto_json;
            console.log('[ANALISE_COMPLETA] produtoJson definido:', {
                has_produto: !!window.produtoJson?.produto,
                produto_nome: window.produtoJson?.produto?.nome
            });
            
            // Atualizar URLs se retornadas
            if (data.image_urls && data.image_urls.length > 0) {
                window.imageUrls = data.image_urls;
                console.log('[ANALISE_COMPLETA] imageUrls atualizado:', window.imageUrls.length);
            }
            if (data.image_paths && data.image_paths.length > 0) {
                window.imagePaths = data.image_paths;
                console.log('[ANALISE_COMPLETA] imagePaths atualizado:', window.imagePaths.length);
            }
            handleAnalysisResult(data);
        } else {
            console.error('[ANALISE_COMPLETA] Erro na resposta:', data.error);
            showError(data.error || 'Erro na an√°lise completa');
            goToStep(1);
        }
    } catch (error) {
        console.error('[ANALISE_COMPLETA] Erro ao processar resposta:', error);
        hideLoading();
        showError('Erro na an√°lise completa: ' + error.message);
        goToStep(1);
    }
}

// Processar resultado da an√°lise
function handleAnalysisResult(result) {
    console.log('[HANDLE_ANALYSIS] Processando resultado da an√°lise');
    console.log('[HANDLE_ANALYSIS] Result:', {
        has_produto_json: !!result.produto_json,
        has_produto: !!result.produto_json?.produto,
        image_paths: result.image_paths?.length || 0,
        image_urls: result.image_urls?.length || 0
    });
    
    const loading = document.getElementById('analysisLoading');
    const resultDiv = document.getElementById('analysisResult');
    
    loading.style.display = 'none';
    resultDiv.style.display = 'block';
    
    // Garantir que produto_json tenha as imagens antes de processar
    if (result.produto_json) {
        if (!result.produto_json.produto) {
            result.produto_json.produto = {};
        }
        
        // Garantir que o array de imagens existe
        if (!result.produto_json.produto.imagens) {
            result.produto_json.produto.imagens = [];
        }
        
        // Adicionar image_paths ao produto_json se dispon√≠vel
        if (result.image_paths && result.image_paths.length > 0) {
            result.image_paths.forEach(path => {
                if (path && path.trim() && !result.produto_json.produto.imagens.includes(path.trim())) {
                    result.produto_json.produto.imagens.push(path.trim().replace(/^\/+/, ''));
                }
            });
            console.log('[HANDLE_ANALYSIS] ‚úì image_paths adicionados ao produto_json.produto.imagens:', result.image_paths);
        }
        
        // Se n√£o tiver paths, tentar extrair de URLs
        if (result.produto_json.produto.imagens.length === 0 && result.image_urls && result.image_urls.length > 0) {
            result.image_urls.forEach(url => {
                if (url && url.trim()) {
                    let path = url.trim();
                    if (url.includes('/media/')) {
                        path = url.split('/media/')[1];
                    } else if (url.includes('produtos/')) {
                        if (url.includes('://')) {
                            const urlObj = new URL(url);
                            path = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                        }
                    }
                    path = path.replace(/^\/+/, '');
                    if (path && !result.produto_json.produto.imagens.includes(path)) {
                        result.produto_json.produto.imagens.push(path);
                    }
                }
            });
            console.log('[HANDLE_ANALYSIS] ‚úì image_urls processados e adicionados:', result.image_urls);
        }
        
        console.log('[HANDLE_ANALYSIS] ‚úì produto.imagens final:', result.produto_json.produto.imagens);
        
        // Atualizar produtoJson global
        window.produtoJson = result.produto_json;
    }
    
    // Preencher formul√°rio com dados extra√≠dos
    if (result.produto_json && result.produto_json.produto) {
        const produto = result.produto_json.produto;
        console.log('[HANDLE_ANALYSIS] Preenchendo formul√°rio com:', {
            nome: produto.nome,
            marca: produto.marca,
            categoria: produto.categoria,
            imagens_count: produto.imagens?.length || 0
        });
        
        document.getElementById('inputName').value = produto.nome || '';
        document.getElementById('inputBrand').value = produto.marca || '';
        document.getElementById('inputCategory').value = produto.categoria || '';
        document.getElementById('inputCodigoBarras').value = produto.codigo_barras || '';
        document.getElementById('inputDescription').value = produto.descricao || '';
        
        // Preencher pre√ßo se dispon√≠vel
        const preco = result.produto_json?.produto_viagem?.preco_venda_brl || 
                     result.produto_json?.produto?.preco || 
                     produto.preco || '';
        if (preco) {
            const priceInput = document.getElementById('inputPrice');
            if (priceInput) {
                // Converter para n√∫mero se for string
                const priceValue = typeof preco === 'string' ? parseFloat(preco.replace(/[^\d.,]/g, '').replace(',', '.')) : preco;
                priceInput.value = priceValue || '';
            }
        }
    } else {
        console.warn('[HANDLE_ANALYSIS] produto_json ou produto n√£o encontrado no resultado');
    }
    
    // Atualizar JSON editor com produto_json j√° atualizado com imagens
    const jsonEditor = document.getElementById('jsonEditor');
    if (jsonEditor && result.produto_json) {
        jsonEditor.value = JSON.stringify(result.produto_json, null, 2);
        console.log('[HANDLE_ANALYSIS] ‚úì JSON editor atualizado com imagens');
    } else {
        console.warn('[HANDLE_ANALYSIS] jsonEditor n√£o encontrado ou produto_json vazio');
    }
}

// ========== ETAPA 4: SALVAMENTO ==========

// Salvar produto
async function saveProduct() {
    console.log('saveProduct() chamado');
    
    if (!validateForm()) {
        console.log('Valida√ß√£o do formul√°rio falhou');
        return;
    }
    
    showLoading('Salvando produto no banco de dados...');
    hideError();
    
    // Verificar se produtoJson existe
    if (!window.produtoJson) {
        console.error('produtoJson est√° vazio ou undefined');
        showError('Erro: Dados do produto n√£o encontrados. Por favor, fa√ßa a an√°lise novamente.');
        hideLoading();
        return;
    }
    
    // Obter JSON editado
    let jsonData = window.produtoJson;
    try {
        const jsonEditorValue = document.getElementById('jsonEditor').value;
        if (jsonEditorValue && jsonEditorValue.trim()) {
            console.log('[SAVE_PRODUCT] Usando JSON do editor');
            jsonData = JSON.parse(jsonEditorValue);
        } else {
            console.log('[SAVE_PRODUCT] Usando window.produtoJson original');
        }
    } catch (e) {
        console.error('[SAVE_PRODUCT] Erro ao parsear JSON:', e);
        showError('JSON inv√°lido. Corrija antes de salvar.');
        hideLoading();
        return;
    }
    
    // Garantir estrutura b√°sica do JSON
    if (!jsonData) {
        console.error('[SAVE_PRODUCT] jsonData est√° vazio ou undefined');
        showError('Erro: Dados do produto n√£o encontrados.');
        hideLoading();
        return;
    }
    
    if (!jsonData.produto) {
        jsonData.produto = {};
    }
    
    // Atualizar JSON com dados do formul√°rio
    jsonData.produto.nome = document.getElementById('inputName').value.trim();
    jsonData.produto.marca = document.getElementById('inputBrand').value.trim();
    jsonData.produto.categoria = document.getElementById('inputCategory').value || jsonData.produto.categoria;
    jsonData.produto.codigo_barras = document.getElementById('inputCodigoBarras').value.trim() || jsonData.produto.codigo_barras;
    jsonData.produto.descricao = document.getElementById('inputDescription').value.trim() || jsonData.produto.descricao;
    
    // Atualizar pre√ßo e estoque
    const priceInput = document.getElementById('inputPrice');
    const estoqueInput = document.getElementById('inputEstoque');
    if (priceInput && priceInput.value) {
        jsonData.produto.preco = priceInput.value;
        if (!jsonData.produto_viagem) {
            jsonData.produto_viagem = {};
        }
        jsonData.produto_viagem.preco_venda_brl = priceInput.value;
    }
    if (estoqueInput && estoqueInput.value) {
        jsonData.produto.estoque = parseInt(estoqueInput.value) || 0;
    }
    
    // CR√çTICO: Garantir que os caminhos das imagens estejam no array produto.imagens
    if (!jsonData.produto.imagens) {
        jsonData.produto.imagens = [];
        console.log('[SAVE_PRODUCT] Criado array produto.imagens vazio');
    }
    
    console.log('[SAVE_PRODUCT] Estado ANTES de adicionar imagens:');
    console.log('[SAVE_PRODUCT] - imagePaths dispon√≠veis:', window.imagePaths);
    console.log('[SAVE_PRODUCT] - imageUrls dispon√≠veis:', window.imageUrls);
    console.log('[SAVE_PRODUCT] - produto.imagens atual:', jsonData.produto.imagens);
    
    // Adicionar imagePaths (caminhos relativos do SinapUm) preferencialmente
    if (window.imagePaths && window.imagePaths.length > 0) {
        console.log('[SAVE_PRODUCT] Adicionando imagePaths ao produto.imagens...');
        window.imagePaths.forEach(path => {
            if (path && path.trim()) {
                // Limpar path se necess√°rio (remover / no in√≠cio)
                const cleanPath = path.trim().replace(/^\/+/, '');
                if (cleanPath && !jsonData.produto.imagens.includes(cleanPath) && !jsonData.produto.imagens.includes(path)) {
                    jsonData.produto.imagens.push(cleanPath);
                    console.log(`[SAVE_PRODUCT] ‚úì Adicionado path: ${cleanPath}`);
                }
            }
        });
        console.log('[SAVE_PRODUCT] ‚úì imagePaths processados:', window.imagePaths);
    } else {
        console.warn('[SAVE_PRODUCT] ‚ö† imagePaths est√° vazio ou n√£o dispon√≠vel');
    }
    
    // Se ainda n√£o tiver imagens, adicionar imageUrls (URLs completas) e extrair paths
    if (jsonData.produto.imagens.length === 0 && window.imageUrls && window.imageUrls.length > 0) {
        console.log('[SAVE_PRODUCT] Adicionando imageUrls e extraindo paths...');
        window.imageUrls.forEach(url => {
            if (url && url.trim()) {
                // Extrair caminho relativo da URL completa se poss√≠vel
                let path = url.trim();
                if (url.includes('/media/')) {
                    path = url.split('/media/')[1];
                } else if (url.includes('produtos/temp/') || url.includes('produtos/')) {
                    // J√° √© um caminho relativo ou tem protocolo
                    if (url.includes('://')) {
                        // Remover protocolo e dom√≠nio
                        const urlObj = new URL(url);
                        path = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                    } else {
                        path = url;
                    }
                } else if (url.startsWith('http')) {
                    // URL completa - tentar extrair path
                    const urlObj = new URL(url);
                    path = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                }
                
                // Limpar path
                path = path.replace(/^\/+/, '');
                
                if (path && !jsonData.produto.imagens.includes(path)) {
                    jsonData.produto.imagens.push(path);
                    console.log(`[SAVE_PRODUCT] ‚úì Adicionado path extra√≠do de URL: ${path} (de ${url})`);
                }
            }
        });
        console.log('[SAVE_PRODUCT] ‚úì imageUrls processados:', window.imageUrls);
    }
    
    console.log('[SAVE_PRODUCT] Estado FINAL:');
    console.log('[SAVE_PRODUCT] - produto.imagens final:', jsonData.produto.imagens);
    console.log('[SAVE_PRODUCT] - Total de imagens no array:', jsonData.produto.imagens.length);
    
    // Obter grupo_id (opcional)
    const grupoIdInput = document.getElementById('inputGroupId');
    const grupoIdValue = grupoIdInput ? grupoIdInput.value : '';
    let grupoId = null;
    
    if (grupoIdValue && grupoIdValue.trim()) {
        grupoId = parseInt(grupoIdValue);
        if (isNaN(grupoId)) {
            console.warn('grupo_id inv√°lido, continuando sem grupo:', grupoIdValue);
            grupoId = null;
        }
    }
    
    // Obter pre√ßo e estoque do formul√°rio
    const priceInput = document.getElementById('inputPrice');
    const estoqueInput = document.getElementById('inputEstoque');
    const price = priceInput && priceInput.value ? priceInput.value : null;
    const estoque = estoqueInput && estoqueInput.value ? estoqueInput.value : null;
    
    const saveData = {
        produto_json: jsonData
    };
    
    // Adicionar grupo_id apenas se v√°lido
    if (grupoId) {
        saveData.grupo_id = grupoId;
    }
    
    // Adicionar pre√ßo e estoque
    if (price) {
        saveData.price = price;
    }
    if (estoque) {
        saveData.estoque = estoque;
    }
    
    console.log('Enviando dados para salvar:', {
        has_produto_json: !!saveData.produto_json,
        grupo_id: saveData.grupo_id,
        price: saveData.price,
        estoque: saveData.estoque
    });
    
    try {
        const response = await fetch('{% url "api_save_product_json" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken
            },
            body: JSON.stringify(saveData)
        });
        
        console.log('Resposta recebida, status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erro na resposta:', errorText);
            throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('[SAVE_PRODUCT] Dados recebidos do servidor:', data);
        console.log('[SAVE_PRODUCT] data.success:', data.success);
        hideLoading();
        
        if (data.success) {
            console.log('[SAVE_PRODUCT] Sucesso! Navegando para etapa 5...');
            const productName = jsonData.produto?.nome || 'Produto';
            console.log('[SAVE_PRODUCT] Nome do produto:', productName);
            
            const successElement = document.getElementById('successProductName');
            if (successElement) {
                successElement.textContent = productName;
                console.log('[SAVE_PRODUCT] Elemento successProductName atualizado');
            } else {
                console.warn('[SAVE_PRODUCT] Elemento successProductName n√£o encontrado!');
            }
            
            console.log('[SAVE_PRODUCT] Chamando goToStep(5)...');
            goToStep(5);
            console.log('[SAVE_PRODUCT] goToStep(5) executado');
        } else {
            console.error('[SAVE_PRODUCT] Erro do servidor:', data.error);
            showError(data.error || 'Erro ao salvar produto');
        }
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
        hideLoading();
        showError('Erro ao salvar produto: ' + error.message);
    }
}

// Validar formul√°rio
function validateForm() {
    const name = document.getElementById('inputName').value.trim();
    
    if (!name) {
        showError('Nome do produto √© obrigat√≥rio');
        return false;
    }
    
    return true;
}

// ========== NAVEGA√á√ÉO ==========

// Navegar entre etapas
function goToStep(step) {
    console.log(`[goToStep] Navegando para etapa ${step}, currentStep atual: ${window.currentStep}`);
    
    // Se for etapa 5 (confirma√ß√£o), apenas mostrar sem atualizar indicadores
    if (step === 5) {
        console.log('[goToStep] Etapa 5 - Ocultando etapas principais...');
        // Ocultar todas as etapas principais
        for (let i = 1; i <= 3; i++) {
            const card = document.getElementById(`stepCard${i}`);
            if (card) {
                card.classList.remove('active');
                console.log(`[goToStep] Etapa ${i} ocultada`);
            } else {
                console.warn(`[goToStep] Etapa ${i} n√£o encontrada`);
            }
        }
        // Mostrar etapa de confirma√ß√£o
        const confirmCard = document.getElementById('stepCard5');
        if (confirmCard) {
            console.log('[goToStep] Mostrando etapa de confirma√ß√£o...');
            confirmCard.style.display = 'block';
            confirmCard.classList.add('active');
            console.log('[goToStep] Etapa 5 exibida com sucesso');
        } else {
            console.error('[goToStep] Elemento stepCard5 n√£o encontrado!');
        }
        window.currentStep = 5;
        console.log(`[goToStep] currentStep atualizado para ${window.currentStep}`);
        return;
    }
    
    // Ocultar etapa de confirma√ß√£o se estiver vis√≠vel
    const confirmCard = document.getElementById('stepCard5');
    if (confirmCard) {
        confirmCard.style.display = 'none';
        confirmCard.classList.remove('active');
    }
    
    // Atualizar indicadores
    for (let i = 1; i <= 3; i++) {
        const card = document.getElementById(`stepCard${i}`);
        const dot = document.getElementById(`step${i}`);
        
        if (i < step) {
            dot.classList.remove('active');
            dot.classList.add('completed');
            card.classList.remove('active');
        } else if (i === step) {
            dot.classList.add('active');
            dot.classList.remove('completed');
            card.classList.add('active');
        } else {
            dot.classList.remove('active', 'completed');
            card.classList.remove('active');
        }
        
        // Atualizar linhas
        if (i < step && i < 3) {
            const line = document.getElementById(`line${i}`);
            if (line) line.classList.add('completed');
        } else if (i < 3) {
            const line = document.getElementById(`line${i}`);
            if (line) line.classList.remove('completed');
        }
    }
    
    window.currentStep = step;
    
    // A√ß√µes espec√≠ficas por etapa
    if (step === 3) {
        renderImagesPreview();
    }
}

// Renderizar preview de imagens na etapa 4
function renderImagesPreview() {
    const container = document.getElementById('imagesPreview');
    container.innerHTML = '';
    
    if (window.imageUrls.length > 0) {
        window.imageUrls.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'image-preview';
            img.alt = 'Imagem do produto';
            container.appendChild(img);
        });
    } else if (window.imagePaths.length > 0) {
        // Se n√£o tiver URLs completas, usar paths (ser√° constru√≠da URL base)
        window.imagePaths.forEach(path => {
            const img = document.createElement('img');
            img.src = path.startsWith('http') ? path : `http://69.169.102.84:5000/${path}`;
            img.className = 'image-preview';
            img.alt = 'Imagem do produto';
            container.appendChild(img);
        });
    }
}

// ========== UTILIT√ÅRIOS ==========

// Toggle editor JSON
function toggleJsonEditor() {
    const editor = document.getElementById('jsonEditor');
    const isReadonly = editor.hasAttribute('readonly');
    
    if (isReadonly) {
        editor.removeAttribute('readonly');
        editor.style.background = '#fff';
        editor.style.border = '2px solid #667eea';
    } else {
        editor.setAttribute('readonly', 'true');
        editor.style.background = '#f8f9fa';
        editor.style.border = '1px solid #dee2e6';
    }
}

// Validar JSON
function validateJson() {
    const editor = document.getElementById('jsonEditor');
    try {
        const json = JSON.parse(editor.value);
        showSuccess('JSON v√°lido! ‚úì');
        setTimeout(() => hideSuccess(), 2000);
    } catch (e) {
        showError('JSON inv√°lido: ' + e.message);
    }
}

// Resetar formul√°rio
function resetForm() {
    window.currentStep = 1;
    window.capturedPhotos = [];
    window.produtoJson = null;
    window.imageUrls = [];
    window.imagePaths = [];
    window.photoIdCounter = 0;
    
    document.getElementById('productForm').reset();
    document.getElementById('jsonEditor').value = '';
    document.getElementById('photosGrid').innerHTML = '';
    document.getElementById('photosGridContainer').style.display = 'none';
    document.getElementById('imagesPreview').innerHTML = '';
    
    // Resetar indicadores
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`step${i}`).classList.remove('active', 'completed');
        const line = document.getElementById(`line${i}`);
        if (line) line.classList.remove('completed');
    }
    document.getElementById('step1').classList.add('active');
    
    stopCamera();
    goToStep(1);
}

// Fun√ß√µes auxiliares
function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function showSuccess(message) {
    const el = document.getElementById('successMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideSuccess() {
    document.getElementById('successMessage').classList.remove('show');
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Limpar ao sair
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}
