{% extends 'app_marketplace/base.html' %}
{% load static %}

{% block title %}Cadastrar Produto por Foto - √âVORA Connect{% endblock %}

{% block extra_css %}
<style>
    .photo-container {
        max-width: 1000px;
        margin: 2rem auto;
    }
    
    .step-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: none;
    }
    
    .step-card.active {
        display: block;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .step-dot {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        position: relative;
        transition: all 0.3s;
    }
    
    .step-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.1);
    }
    
    .step-dot.completed {
        background: #28a745;
        color: white;
    }
    
    .step-line {
        width: 80px;
        height: 3px;
        background: #e0e0e0;
        transition: all 0.3s;
    }
    
    .step-line.completed {
        background: #28a745;
    }
    
    .step-label {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.75rem;
        color: #666;
        font-weight: normal;
    }
    
    .step-dot.active .step-label {
        color: #667eea;
        font-weight: bold;
    }
    
    /* C√¢mera */
    .camera-preview {
        width: 100%;
        max-width: 100%;
        border-radius: 10px;
        background: #000;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .camera-preview video,
    .camera-preview img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
    }
    
    .camera-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-camera {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 4px solid white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .btn-camera:active {
        transform: scale(0.95);
    }
    
    .btn-capture {
        background: #28a745;
        color: white;
    }
    
    .btn-close-camera {
        background: #dc3545;
        color: white;
    }
    
    /* Grid de Fotos */
    .photos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .photo-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        aspect-ratio: 1;
    }
    
    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .photo-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .photo-item .remove-btn:hover {
        background: rgba(220, 53, 69, 1);
        transform: scale(1.1);
    }
    
    /* Loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        text-align: center;
        color: white;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message, .success-message {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .error-message.show {
        display: block;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .success-message.show {
        display: block;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .permission-prompt {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        border-radius: 10px;
        margin: 1rem 0;
    }
    
    .verification-result {
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
        text-align: center;
    }
    
    .verification-result.success {
        background: #d4edda;
        border: 2px solid #28a745;
        color: #155724;
    }
    
    .verification-result.warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
    }
    
    .json-editor {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        width: 100%;
    }
    
    .image-preview-container {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 400px;
        margin: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="photo-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-camera"></i> Cadastrar Produto por Foto
            </h1>
            <a href="{% url 'shopper_products' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
        
        <!-- Indicador de Passos (3 etapas) -->
        <div class="step-indicator">
            <div class="step-dot active" id="step1">
                1
                <span class="step-label">Capturar</span>
            </div>
            <div class="step-line" id="line1"></div>
            <div class="step-dot" id="step2">
                2
                <span class="step-label">Analisar</span>
            </div>
            <div class="step-line" id="line2"></div>
            <div class="step-dot" id="step3">
                3
                <span class="step-label">Salvar</span>
            </div>
        </div>
        
        <!-- Mensagens -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- ETAPA 1: Captura de M√∫ltiplas Fotos -->
        <div class="step-card active" id="stepCard1">
            <h4 class="mb-3">üì∑ Etapa 1: Capture fotos do produto</h4>
            <p class="text-muted">Capture m√∫ltiplas fotos do mesmo produto. Voc√™ pode remover ou adicionar mais fotos antes de analisar.</p>
            
            <div class="permission-prompt" id="permissionPrompt">
                <i class="fas fa-camera" style="font-size: 3rem; color: #ffc107;"></i>
                <h5>Permiss√£o de C√¢mera</h5>
                <p>Clique em "Iniciar C√¢mera" para permitir o acesso √† c√¢mera do seu dispositivo.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary" onclick="startCamera()">
                        <i class="fas fa-video"></i> Iniciar C√¢mera
                    </button>
                    <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                        <i class="fas fa-images"></i> Escolher da Galeria
                    </button>
                </div>
            </div>
            
            <div class="camera-preview" id="cameraPreview">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 4rem;"></i>
                    <p>Inicie a c√¢mera ou escolha uma foto</p>
                </div>
            </div>
            
            <div class="camera-controls" id="cameraControls" style="display: none;">
                <button class="btn btn-close-camera btn-camera" onclick="stopCamera()" title="Fechar c√¢mera">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-capture btn-camera" onclick="capturePhoto()" title="Capturar foto">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
            
            <!-- Grid de Fotos Capturadas -->
            <div id="photosGridContainer" style="display: none;">
                <h5 class="mt-4 mb-3">Fotos Capturadas (<span id="photoCount">0</span>)</h5>
                <div class="photos-grid" id="photosGrid"></div>
                <div class="d-flex gap-2 justify-content-center mt-3">
                    <button class="btn btn-outline-primary" onclick="selectFromGallery()">
                        <i class="fas fa-plus"></i> Adicionar Mais Fotos
                    </button>
                    <button class="btn btn-primary" onclick="analyzeComplete()" id="btnAnalyze" disabled>
                        <i class="fas fa-robot"></i> Analisar Produto
                    </button>
                </div>
            </div>
            
            <canvas id="captureCanvas" style="display: none;"></canvas>
            <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;" onchange="handleGallerySelect(event)">
        </div>
        
        <!-- ETAPA 2: An√°lise Completa -->
        <div class="step-card" id="stepCard2">
            <h4 class="mb-3">ü§ñ Etapa 2: An√°lise completa com IA</h4>
            <p class="text-muted">Gerando JSON completo do produto com todas as informa√ß√µes extra√≠das...</p>
            
            <div id="analysisLoading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="mt-3" id="analysisProgress">Analisando imagens e gerando dados do produto...</p>
            </div>
            
            <div id="analysisResult" style="display: none;">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> An√°lise completa conclu√≠da!
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <button class="btn btn-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary" onclick="goToStep(3)">
                        <i class="fas fa-eye"></i> Revisar e Salvar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ETAPA 3: Revis√£o e Salvamento -->
        <div class="step-card" id="stepCard3">
            <h4 class="mb-3">‚úÖ Etapa 3: Revisar e Salvar</h4>
            <p class="text-muted">Revise os dados extra√≠dos e salve o produto no banco de dados.</p>
            
            <!-- Preview de Imagens -->
            <div id="imagesPreviewContainer" class="mb-4">
                <h5>Imagens do Produto</h5>
                <div class="image-preview-container" id="imagesPreview"></div>
            </div>
            
            <!-- Formul√°rio de Dados -->
            <form id="productForm">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Nome do Produto *</label>
                            <input type="text" name="name" id="inputName" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" name="brand" id="inputBrand" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select name="category" id="inputCategory" class="form-select">
                                <option value="">Selecione...</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" name="codigo_barras" id="inputCodigoBarras" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea name="description" id="inputDescription" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Grupo WhatsApp</label>
                    <select name="group_id" id="inputGroupId" class="form-select">
                        <option value="">Selecione um grupo...</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Editor JSON -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-code"></i> JSON Completo (modelo.json)
                        <small class="text-muted">Edite se necess√°rio</small>
                    </label>
                    <textarea id="jsonEditor" class="json-editor"></textarea>
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleJsonEditor()">
                            <i class="fas fa-edit"></i> Editar JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="validateJson()">
                            <i class="fas fa-check"></i> Validar JSON
                        </button>
                    </div>
                </div>
                
                <div class="d-flex gap-2 justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save"></i> Salvar no Banco
                    </button>
                </div>
            </form>
        </div>
        
        <!-- ETAPA 5: Confirma√ß√£o -->
        <div class="step-card" id="stepCard5" style="display: none;">
            <h4 class="mb-3">‚úÖ Produto Cadastrado!</h4>
            <div class="text-center">
                <i class="fas fa-check-circle" style="font-size: 5rem; color: #28a745;"></i>
                <h5 class="mt-3" id="successProductName"></h5>
                <p class="text-muted">Produto cadastrado com sucesso!</p>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <a href="{% url 'shopper_products' %}" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Meus Produtos
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                        <i class="fas fa-plus"></i> Cadastrar Outro
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h5 class="text-white">Processando...</h5>
        <p class="text-white-50" id="loadingMessage">Aguarde...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vari√°veis globais
let stream = null;
let capturedPhotos = [];  // Array de {id, blob, preview}
let currentStep = 1;
let produtoJson = null;
let imageUrls = [];
let imagePaths = [];
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let photoIdCounter = 0;

// Verificar suporte
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('permissionPrompt').innerHTML = 
        '<p class="text-danger">C√¢mera n√£o suportada neste navegador</p>';
}

// ========== ETAPA 1: CAPTURA ==========

// Iniciar c√¢mera
async function startCamera() {
    try {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        const preview = document.getElementById('cameraPreview');
        preview.innerHTML = '<video id="cameraVideo" autoplay playsinline></video>';
        
        const video = document.getElementById('cameraVideo');
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            document.getElementById('permissionPrompt').style.display = 'none';
            document.getElementById('cameraControls').style.display = 'flex';
        };
        
        hideError();
    } catch (error) {
        showError('Erro ao acessar c√¢mera: ' + error.message);
    }
}

// Parar c√¢mera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    document.getElementById('cameraPreview').innerHTML = 
        '<div style="color: white; text-align: center;"><i class="fas fa-camera" style="font-size: 4rem;"></i><p>Inicie a c√¢mera ou escolha uma foto</p></div>';
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('permissionPrompt').style.display = 'block';
}

// Escolher da galeria
function selectFromGallery() {
    document.getElementById('galleryInput').click();
}

function handleGallerySelect(event) {
    const files = Array.from(event.target.files);
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            addPhotoFromFile(file);
        }
    });
    // Limpar input para permitir selecionar o mesmo arquivo novamente
    event.target.value = '';
}

// Adicionar foto do arquivo
function addPhotoFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const blob = file;
        addPhotoToArray(blob, e.target.result);
    };
    reader.readAsDataURL(file);
}

// Capturar foto da c√¢mera
function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    if (!video) {
        showError('Nenhuma imagem capturada');
        return;
    }
    
    const canvas = document.getElementById('captureCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        const preview = URL.createObjectURL(blob);
        addPhotoToArray(blob, preview);
    }, 'image/jpeg', 0.9);
}

// Adicionar foto ao array
function addPhotoToArray(blob, preview) {
    const photo = {
        id: photoIdCounter++,
        blob: blob,
        preview: preview
    };
    capturedPhotos.push(photo);
    renderPhotoGrid();
    updateAnalyzeButton();
}

// Remover foto
function removePhoto(id) {
    capturedPhotos = capturedPhotos.filter(p => p.id !== id);
    renderPhotoGrid();
    updateAnalyzeButton();
}

// Renderizar grid de fotos
function renderPhotoGrid() {
    const grid = document.getElementById('photosGrid');
    const container = document.getElementById('photosGridContainer');
    const count = document.getElementById('photoCount');
    
    if (capturedPhotos.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    count.textContent = capturedPhotos.length;
    
    grid.innerHTML = capturedPhotos.map(photo => `
        <div class="photo-item">
            <img src="${photo.preview}" alt="Foto ${photo.id}">
            <button class="remove-btn" onclick="removePhoto(${photo.id})" title="Remover foto">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// Atualizar bot√£o de analisar
function updateAnalyzeButton() {
    const btn = document.getElementById('btnAnalyze');
    if (btn) {
        btn.disabled = capturedPhotos.length === 0;
    }
}

// ========== ETAPA 2: AN√ÅLISE COMPLETA ==========

// An√°lise completa
async function analyzeComplete() {
    console.log('[ANALISE_COMPLETA] Iniciando an√°lise completa');
    console.log('[ANALISE_COMPLETA] Fotos capturadas:', capturedPhotos.length);
    
    if (capturedPhotos.length === 0) {
        console.error('[ANALISE_COMPLETA] Nenhuma foto capturada');
        showError('Capture pelo menos uma foto antes de analisar');
        return;
    }
    
    goToStep(2);
    showLoading('Realizando an√°lise completa com IA...');
    hideError();
    
    // Fazer upload das fotos diretamente
    const formData = new FormData();
    capturedPhotos.forEach((photo, index) => {
        const file = new File([photo.blob], `photo_${photo.id}.jpg`, { type: 'image/jpeg' });
        formData.append('images', file);
        console.log(`[ANALISE_COMPLETA] Adicionando foto ${index + 1}/${capturedPhotos.length}: photo_${photo.id}.jpg`);
    });
    
    console.log('[ANALISE_COMPLETA] Enviando requisi√ß√£o para an√°lise completa...');
    let response;
    try {
        response = await fetch('{% url "api_analise_completa" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        console.log('[ANALISE_COMPLETA] Resposta recebida, status:', response.status);
    } catch (error) {
        console.error('[ANALISE_COMPLETA] Erro ao fazer upload:', error);
        hideLoading();
        showError('Erro ao fazer upload: ' + error.message);
        goToStep(1);
        return;
    }
    
    try {
        const data = await response.json();
        console.log('[ANALISE_COMPLETA] Dados recebidos:', {
            success: data.success,
            has_produto_json: !!data.produto_json,
            image_urls: data.image_urls?.length || 0,
            image_paths: data.image_paths?.length || 0
        });
        hideLoading();
        
        if (data.success) {
            produtoJson = data.produto_json;
            console.log('[ANALISE_COMPLETA] produtoJson definido:', {
                has_produto: !!produtoJson?.produto,
                produto_nome: produtoJson?.produto?.nome
            });
            
            // Atualizar URLs se retornadas
            if (data.image_urls && data.image_urls.length > 0) {
                imageUrls = data.image_urls;
                console.log('[ANALISE_COMPLETA] imageUrls atualizado:', imageUrls.length);
            }
            if (data.image_paths && data.image_paths.length > 0) {
                imagePaths = data.image_paths;
                console.log('[ANALISE_COMPLETA] imagePaths atualizado:', imagePaths.length);
            }
            handleAnalysisResult(data);
        } else {
            console.error('[ANALISE_COMPLETA] Erro na resposta:', data.error);
            showError(data.error || 'Erro na an√°lise completa');
            goToStep(1);
        }
    } catch (error) {
        console.error('[ANALISE_COMPLETA] Erro ao processar resposta:', error);
        hideLoading();
        showError('Erro na an√°lise completa: ' + error.message);
        goToStep(1);
    }
}

// Processar resultado da an√°lise
function handleAnalysisResult(result) {
    console.log('[HANDLE_ANALYSIS] Processando resultado da an√°lise');
    console.log('[HANDLE_ANALYSIS] Result:', {
        has_produto_json: !!result.produto_json,
        has_produto: !!result.produto_json?.produto
    });
    
    const loading = document.getElementById('analysisLoading');
    const resultDiv = document.getElementById('analysisResult');
    
    loading.style.display = 'none';
    resultDiv.style.display = 'block';
    
    // Preencher formul√°rio com dados extra√≠dos
    if (result.produto_json && result.produto_json.produto) {
        const produto = result.produto_json.produto;
        console.log('[HANDLE_ANALYSIS] Preenchendo formul√°rio com:', {
            nome: produto.nome,
            marca: produto.marca,
            categoria: produto.categoria
        });
        
        document.getElementById('inputName').value = produto.nome || '';
        document.getElementById('inputBrand').value = produto.marca || '';
        document.getElementById('inputCategory').value = produto.categoria || '';
        document.getElementById('inputCodigoBarras').value = produto.codigo_barras || '';
        document.getElementById('inputDescription').value = produto.descricao || '';
    } else {
        console.warn('[HANDLE_ANALYSIS] produto_json ou produto n√£o encontrado no resultado');
    }
    
    // Atualizar JSON editor
    const jsonEditor = document.getElementById('jsonEditor');
    if (jsonEditor && result.produto_json) {
        jsonEditor.value = JSON.stringify(result.produto_json, null, 2);
        console.log('[HANDLE_ANALYSIS] JSON editor atualizado');
    } else {
        console.warn('[HANDLE_ANALYSIS] jsonEditor n√£o encontrado ou produto_json vazio');
    }
}

// ========== ETAPA 4: SALVAMENTO ==========

// Salvar produto
async function saveProduct() {
    console.log('saveProduct() chamado');
    
    if (!validateForm()) {
        console.log('Valida√ß√£o do formul√°rio falhou');
        return;
    }
    
    showLoading('Salvando produto no banco de dados...');
    hideError();
    
    // Verificar se produtoJson existe
    if (!produtoJson) {
        console.error('produtoJson est√° vazio ou undefined');
        showError('Erro: Dados do produto n√£o encontrados. Por favor, fa√ßa a an√°lise novamente.');
        hideLoading();
        return;
    }
    
    // Obter JSON editado
    let jsonData = produtoJson;
    try {
        const jsonEditorValue = document.getElementById('jsonEditor').value;
        if (jsonEditorValue && jsonEditorValue.trim()) {
            console.log('Usando JSON do editor');
            jsonData = JSON.parse(jsonEditorValue);
        } else {
            console.log('Usando produtoJson original');
        }
    } catch (e) {
        console.error('Erro ao parsear JSON:', e);
        showError('JSON inv√°lido. Corrija antes de salvar.');
        hideLoading();
        return;
    }
    
    // Atualizar JSON com dados do formul√°rio
    if (jsonData && jsonData.produto) {
        jsonData.produto.nome = document.getElementById('inputName').value.trim();
        jsonData.produto.marca = document.getElementById('inputBrand').value.trim();
        jsonData.produto.categoria = document.getElementById('inputCategory').value || jsonData.produto.categoria;
        jsonData.produto.codigo_barras = document.getElementById('inputCodigoBarras').value.trim() || jsonData.produto.codigo_barras;
        jsonData.produto.descricao = document.getElementById('inputDescription').value.trim() || jsonData.produto.descricao;
    }
    
    // Obter grupo_id (opcional)
    const grupoIdInput = document.getElementById('inputGroupId');
    const grupoIdValue = grupoIdInput ? grupoIdInput.value : '';
    let grupoId = null;
    
    if (grupoIdValue && grupoIdValue.trim()) {
        grupoId = parseInt(grupoIdValue);
        if (isNaN(grupoId)) {
            console.warn('grupo_id inv√°lido, continuando sem grupo:', grupoIdValue);
            grupoId = null;
        }
    }
    
    const saveData = {
        produto_json: jsonData
    };
    
    // Adicionar grupo_id apenas se v√°lido
    if (grupoId) {
        saveData.grupo_id = grupoId;
    }
    
    console.log('Enviando dados para salvar:', {
        has_produto_json: !!saveData.produto_json,
        grupo_id: saveData.grupo_id
    });
    
    try {
        const response = await fetch('{% url "api_save_product_json" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(saveData)
        });
        
        console.log('Resposta recebida, status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erro na resposta:', errorText);
            throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('[SAVE_PRODUCT] Dados recebidos do servidor:', data);
        console.log('[SAVE_PRODUCT] data.success:', data.success);
        hideLoading();
        
        if (data.success) {
            console.log('[SAVE_PRODUCT] Sucesso! Navegando para etapa 5...');
            const productName = jsonData.produto?.nome || 'Produto';
            console.log('[SAVE_PRODUCT] Nome do produto:', productName);
            
            const successElement = document.getElementById('successProductName');
            if (successElement) {
                successElement.textContent = productName;
                console.log('[SAVE_PRODUCT] Elemento successProductName atualizado');
            } else {
                console.warn('[SAVE_PRODUCT] Elemento successProductName n√£o encontrado!');
            }
            
            console.log('[SAVE_PRODUCT] Chamando goToStep(5)...');
            goToStep(5);
            console.log('[SAVE_PRODUCT] goToStep(5) executado');
        } else {
            console.error('[SAVE_PRODUCT] Erro do servidor:', data.error);
            showError(data.error || 'Erro ao salvar produto');
        }
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
        hideLoading();
        showError('Erro ao salvar produto: ' + error.message);
    }
}

// Validar formul√°rio
function validateForm() {
    const name = document.getElementById('inputName').value.trim();
    
    if (!name) {
        showError('Nome do produto √© obrigat√≥rio');
        return false;
    }
    
    return true;
}

// ========== NAVEGA√á√ÉO ==========

// Navegar entre etapas
function goToStep(step) {
    console.log(`[goToStep] Navegando para etapa ${step}, currentStep atual: ${currentStep}`);
    
    // Se for etapa 5 (confirma√ß√£o), apenas mostrar sem atualizar indicadores
    if (step === 5) {
        console.log('[goToStep] Etapa 5 - Ocultando etapas principais...');
        // Ocultar todas as etapas principais
        for (let i = 1; i <= 3; i++) {
            const card = document.getElementById(`stepCard${i}`);
            if (card) {
                card.classList.remove('active');
                console.log(`[goToStep] Etapa ${i} ocultada`);
            } else {
                console.warn(`[goToStep] Etapa ${i} n√£o encontrada`);
            }
        }
        // Mostrar etapa de confirma√ß√£o
        const confirmCard = document.getElementById('stepCard5');
        if (confirmCard) {
            console.log('[goToStep] Mostrando etapa de confirma√ß√£o...');
            confirmCard.style.display = 'block';
            confirmCard.classList.add('active');
            console.log('[goToStep] Etapa 5 exibida com sucesso');
        } else {
            console.error('[goToStep] Elemento stepCard5 n√£o encontrado!');
        }
        currentStep = 5;
        console.log(`[goToStep] currentStep atualizado para ${currentStep}`);
        return;
    }
    
    // Ocultar etapa de confirma√ß√£o se estiver vis√≠vel
    const confirmCard = document.getElementById('stepCard5');
    if (confirmCard) {
        confirmCard.style.display = 'none';
        confirmCard.classList.remove('active');
    }
    
    // Atualizar indicadores
    for (let i = 1; i <= 3; i++) {
        const card = document.getElementById(`stepCard${i}`);
        const dot = document.getElementById(`step${i}`);
        
        if (i < step) {
            dot.classList.remove('active');
            dot.classList.add('completed');
            card.classList.remove('active');
        } else if (i === step) {
            dot.classList.add('active');
            dot.classList.remove('completed');
            card.classList.add('active');
        } else {
            dot.classList.remove('active', 'completed');
            card.classList.remove('active');
        }
        
        // Atualizar linhas
        if (i < step && i < 3) {
            const line = document.getElementById(`line${i}`);
            if (line) line.classList.add('completed');
        } else if (i < 3) {
            const line = document.getElementById(`line${i}`);
            if (line) line.classList.remove('completed');
        }
    }
    
    currentStep = step;
    
    // A√ß√µes espec√≠ficas por etapa
    if (step === 3) {
        renderImagesPreview();
    }
}

// Renderizar preview de imagens na etapa 4
function renderImagesPreview() {
    const container = document.getElementById('imagesPreview');
    container.innerHTML = '';
    
    if (imageUrls.length > 0) {
        imageUrls.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            img.className = 'image-preview';
            img.alt = 'Imagem do produto';
            container.appendChild(img);
        });
    } else if (imagePaths.length > 0) {
        // Se n√£o tiver URLs completas, usar paths (ser√° constru√≠da URL base)
        imagePaths.forEach(path => {
            const img = document.createElement('img');
            img.src = path.startsWith('http') ? path : `http://69.169.102.84:5000/${path}`;
            img.className = 'image-preview';
            img.alt = 'Imagem do produto';
            container.appendChild(img);
        });
    }
}

// ========== UTILIT√ÅRIOS ==========

// Toggle editor JSON
function toggleJsonEditor() {
    const editor = document.getElementById('jsonEditor');
    const isReadonly = editor.hasAttribute('readonly');
    
    if (isReadonly) {
        editor.removeAttribute('readonly');
        editor.style.background = '#fff';
        editor.style.border = '2px solid #667eea';
    } else {
        editor.setAttribute('readonly', 'true');
        editor.style.background = '#f8f9fa';
        editor.style.border = '1px solid #dee2e6';
    }
}

// Validar JSON
function validateJson() {
    const editor = document.getElementById('jsonEditor');
    try {
        const json = JSON.parse(editor.value);
        showSuccess('JSON v√°lido! ‚úì');
        setTimeout(() => hideSuccess(), 2000);
    } catch (e) {
        showError('JSON inv√°lido: ' + e.message);
    }
}

// Resetar formul√°rio
function resetForm() {
    currentStep = 1;
    capturedPhotos = [];
    produtoJson = null;
    imageUrls = [];
    imagePaths = [];
    photoIdCounter = 0;
    
    document.getElementById('productForm').reset();
    document.getElementById('jsonEditor').value = '';
    document.getElementById('photosGrid').innerHTML = '';
    document.getElementById('photosGridContainer').style.display = 'none';
    document.getElementById('imagesPreview').innerHTML = '';
    
    // Resetar indicadores
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`step${i}`).classList.remove('active', 'completed');
        const line = document.getElementById(`line${i}`);
        if (line) line.classList.remove('completed');
    }
    document.getElementById('step1').classList.add('active');
    
    stopCamera();
    goToStep(1);
}

// Fun√ß√µes auxiliares
function showError(message) {
    const el = document.getElementById('errorMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function showSuccess(message) {
    const el = document.getElementById('successMessage');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function hideSuccess() {
    document.getElementById('successMessage').classList.remove('show');
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Limpar ao sair
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}
