<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ÉVORA Connect - Plataforma de Dropkeeping com Keeper Mesh Network (KMN)">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÉVORA Connect">
    
    <!-- PWA Manifest -->
    {% load static %}
    <link rel="manifest" href="{% static 'app_marketplace/manifest.json' %}">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'app_marketplace/icons/icon-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'app_marketplace/icons/icon-512x512.png' %}">
    <link rel="apple-touch-icon" href="{% static 'app_marketplace/icons/icon-192x192.png' %}">
    
    <title>{% block title %}ÉVORA Connect - VitrineZap{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'app_marketplace/css/style.css' %}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navbar Principal -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{% url 'home' %}">
                <i class="fas fa-store"></i> ÉVORA Connect
            </a>
            
            {% if user.is_authenticated %}
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        {% if user.is_superuser %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'admin_dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard Admin
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/" target="_blank">
                                    <i class="fas fa-cog"></i> Admin Django
                                </a>
                            </li>
                        {% elif user.is_shopper %}
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'shopper_dashboard' %}active{% endif %}" href="{% url 'shopper_dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_groups' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_groups' %}">
                                    <i class="fab fa-whatsapp"></i> Grupos WhatsApp
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_products' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_products' %}">
                                    <i class="fas fa-box"></i> Produtos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_orders' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_orders' %}">
                                    <i class="fas fa-shopping-cart"></i> Pedidos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_analytics' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_analytics' %}">
                                    <i class="fas fa-chart-line"></i> Analytics
                                </a>
                            </li>
                            
                            <!-- Dropdown KMN -->
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle {% if 'kmn_' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-network-wired"></i> KMN
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_dashboard' %}active{% endif %}" href="{% url 'kmn_dashboard' %}">
                                        <i class="fas fa-tachometer-alt"></i> Dashboard KMN
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_ofertas' %}active{% endif %}" href="{% url 'kmn_ofertas' %}">
                                        <i class="fas fa-tags"></i> Minhas Ofertas
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_estoque' %}active{% endif %}" href="{% url 'kmn_estoque' %}">
                                        <i class="fas fa-boxes"></i> Estoque
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_clientes' %}active{% endif %}" href="{% url 'kmn_clientes' %}">
                                        <i class="fas fa-users"></i> Clientes
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_trustlines' %}active{% endif %}" href="{% url 'kmn_trustlines' %}">
                                        <i class="fas fa-handshake"></i> Trustlines
                                    </a></li>
                                </ul>
                            </li>
                            
                        <!-- Menu para Keepers -->
                        {% elif user.is_address_keeper %}
                            <li class="nav-item">
                                <a class="nav-link {% if 'whatsapp_dashboard' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'whatsapp_dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_groups' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_groups' %}">
                                    <i class="fab fa-whatsapp"></i> Grupos WhatsApp
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_products' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_products' %}">
                                    <i class="fas fa-box"></i> Produtos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_orders' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_orders' %}">
                                    <i class="fas fa-shopping-cart"></i> Pedidos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if 'shopper_analytics' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'shopper_analytics' %}">
                                    <i class="fas fa-chart-line"></i> Analytics
                                </a>
                            </li>
                            
                            <!-- Dropdown KMN -->
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle {% if 'kmn_' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-network-wired"></i> KMN
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_dashboard' %}active{% endif %}" href="{% url 'kmn_dashboard' %}">
                                        <i class="fas fa-tachometer-alt"></i> Dashboard KMN
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_ofertas' %}active{% endif %}" href="{% url 'kmn_ofertas' %}">
                                        <i class="fas fa-tags"></i> Minhas Ofertas
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_estoque' %}active{% endif %}" href="{% url 'kmn_estoque' %}">
                                        <i class="fas fa-boxes"></i> Estoque
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_clientes' %}active{% endif %}" href="{% url 'kmn_clientes' %}">
                                        <i class="fas fa-users"></i> Clientes
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_trustlines' %}active{% endif %}" href="{% url 'kmn_trustlines' %}">
                                        <i class="fas fa-handshake"></i> Trustlines
                                    </a></li>
                                </ul>
                            </li>
                        {% elif user.is_address_keeper %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'whatsapp_dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle {% if 'kmn_' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-network-wired"></i> KMN
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_dashboard' %}active{% endif %}" href="{% url 'kmn_dashboard' %}">
                                        <i class="fas fa-tachometer-alt"></i> Dashboard KMN
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_ofertas' %}active{% endif %}" href="{% url 'kmn_ofertas' %}">
                                        <i class="fas fa-tags"></i> Minhas Ofertas
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_estoque' %}active{% endif %}" href="{% url 'kmn_estoque' %}">
                                        <i class="fas fa-boxes"></i> Estoque
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_clientes' %}active{% endif %}" href="{% url 'kmn_clientes' %}">
                                        <i class="fas fa-users"></i> Clientes
                                    </a></li>
                                    <li><a class="dropdown-item {% if request.resolver_match.url_name == 'kmn_trustlines' %}active{% endif %}" href="{% url 'kmn_trustlines' %}">
                                        <i class="fas fa-handshake"></i> Trustlines
                                    </a></li>
                                </ul>
                            </li>
                        {% elif user.is_cliente %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'client_dashboard' %}">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'escolher_shoppers' %}active{% endif %}" href="{% url 'escolher_shoppers' %}">
                                    <i class="fas fa-user-plus"></i> Seguir Shoppers
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'client_products' %}active{% endif %}" href="{% url 'client_products' %}">
                                    <i class="fas fa-shopping-bag"></i> Produtos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'client_orders' %}active{% endif %}" href="{% url 'client_orders' %}">
                                    <i class="fas fa-shopping-cart"></i> Meus Pedidos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'client_packages' %}">
                                    <i class="fas fa-box"></i> Meus Pacotes
                                </a>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">
                                    <i class="fas fa-home"></i> Home
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'personal_shoppers' %}active{% endif %}" href="{% url 'personal_shoppers' %}">
                                    <i class="fas fa-user-tie"></i> Personal Shoppers
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}" href="{% url 'pedidos' %}">
                                    <i class="fas fa-shopping-cart"></i> Minhas Compras
                                </a>
                            </li>
                            {% if user.is_agente %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle {% if 'kmn_' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-network-wired"></i> KMN
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'kmn_dashboard' %}">
                                        <i class="fas fa-tachometer-alt"></i> Dashboard KMN
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'kmn_ofertas' %}">
                                        <i class="fas fa-tags"></i> Ofertas
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'kmn_clientes' %}">
                                        <i class="fas fa-users"></i> Clientes
                                    </a></li>
                                </ul>
                            </li>
                            {% endif %}
                        {% endif %}
                    </ul>
                    
                    <!-- Área do usuário -->
                    <div class="navbar-nav ms-auto">
                        {% if user.is_authenticated %}
                            <div class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user-circle"></i>
                                    <span class="ms-1">{{ user.get_full_name|default:user.username }}</span>
                                    {% if user.is_superuser %}
                                        <span class="badge bg-danger ms-2">Admin</span>
                                    {% elif user.is_shopper %}
                                        <span class="badge bg-success ms-2">Shopper</span>
                                    {% elif user.is_address_keeper %}
                                        <span class="badge bg-info ms-2">Address Keeper</span>
                                    {% elif user.is_cliente %}
                                        <span class="badge bg-primary ms-2">Cliente</span>
                                    {% elif user.is_agente %}
                                        <span class="badge bg-warning text-dark ms-2">Agente</span>
                                    {% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><h6 class="dropdown-header">
                                        <i class="fas fa-user"></i> {{ user.username }}
                                    </h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'home' %}">
                                        <i class="fas fa-home"></i> Início
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="{% url 'logout' %}">
                                        <i class="fas fa-sign-out-alt"></i> Sair
                                    </a></li>
                                </ul>
                            </div>
                        {% else %}
                            <a class="btn btn-outline-light me-2" href="{% url 'login' %}">
                                <i class="fas fa-sign-in-alt"></i> Entrar
                            </a>
                            <a class="btn btn-primary" href="{% url 'cadastro' %}">
                                <i class="fas fa-user-plus"></i> Cadastrar
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <!-- Menu para usuários não autenticados -->
                <div class="navbar-nav ms-auto">
                    <a class="btn btn-outline-light me-2" href="{% url 'index' %}">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a class="btn btn-outline-light me-2" href="{% url 'login' %}">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </a>
                    <a class="btn btn-primary" href="{% url 'cadastro' %}">
                        <i class="fas fa-user-plus"></i> Cadastrar
                    </a>
                </div>
            {% endif %}
        </div>
    </nav>

    <!-- Breadcrumbs (opcional, pode ser sobrescrito nos templates) -->
    {% block breadcrumbs %}
    {% if user.is_authenticated %}
    <nav aria-label="breadcrumb" class="bg-light border-bottom">
        <div class="container-fluid">
            <ol class="breadcrumb mb-0 py-2">
                <li class="breadcrumb-item">
                    <a href="{% url 'home' %}">
                        <i class="fas fa-home"></i> Início
                    </a>
                </li>
                {% block breadcrumb_items %}{% endblock %}
            </ol>
        </div>
    </nav>
    {% endif %}
    {% endblock %}

    <!-- Mensagens do Django -->
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{% if message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Conteúdo Principal -->
    <main class="{% block main_class %}container-fluid mt-4 mb-5{% endblock %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-store"></i> ÉVORA Connect</h5>
                    <p class="text-muted">Plataforma de Dropkeeping com Keeper Mesh Network (KMN)</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted mb-0">
                        &copy; {% now "Y" %} ÉVORA Connect. Todos os direitos reservados.
                    </p>
                    <p class="text-muted small mb-0">
                        <a href="{% url 'admin:index' %}" class="text-muted text-decoration-none" target="_blank">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PWA Install Script -->
    <script src="{% static 'app_marketplace/pwa-install.js' %}"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{% static 'app_marketplace/sw.js' %}')
                    .then((registration) => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
